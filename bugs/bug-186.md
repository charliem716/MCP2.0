# BUG-186: Event monitoring cannot be enabled/disabled at runtime via MCP tools

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: Event Monitoring / MCP Tools / Configuration Management  
**Reported Date**: 2025-08-08  
**Reporter**: System Architecture Review  
**Assignee**: Unassigned

## Summary

Event monitoring feature requires application restart to enable or disable, as it only reads the `EVENT_MONITORING_ENABLED` environment variable at startup. This prevents dynamic configuration through MCP tools, limiting operational flexibility.

## Description

The event monitoring system (SQLite-based event tracking) can only be configured via environment variables that are read once at application startup. This creates several operational issues:

- **What is happening**: Event monitoring state is fixed at startup based on `EVENT_MONITORING_ENABLED` environment variable
- **What should happen**: Event monitoring should be controllable at runtime via MCP tools
- **When the issue occurs**: Whenever users need to enable/disable event monitoring without restarting
- **Impact**: 
  - Requires full application restart to change monitoring state
  - Cannot dynamically enable monitoring for debugging production issues
  - Cannot disable monitoring to conserve resources when not needed
  - Poor user experience for configuration management

## Steps to Reproduce

1. Start MCP server without `EVENT_MONITORING_ENABLED` set
2. Attempt to use `qsys:query_change_events` tool
3. Receive error: "Event monitoring is not enabled in this environment"
4. Set `EVENT_MONITORING_ENABLED=true` in environment
5. Must restart entire application for change to take effect
6. Only now can event monitoring tools be used

## Expected Behavior

Users should be able to:
1. Query current event monitoring status via MCP tool
2. Enable event monitoring at runtime via MCP tool
3. Disable event monitoring at runtime via MCP tool
4. Configure event monitoring settings (database path, retention) via MCP tool
5. Changes take effect immediately without restart

Example tool usage:
```json
// Check status
{
  "tool": "qsys:configure_system",
  "action": "get",
  "setting": "event_monitoring"
}

// Enable monitoring
{
  "tool": "qsys:configure_system", 
  "action": "set",
  "setting": "event_monitoring",
  "value": {
    "enabled": true,
    "dbPath": "./data/events",
    "retentionDays": 7
  }
}
```

## Actual Behavior

- Event monitoring state is read once from `process.env.EVENT_MONITORING_ENABLED` at startup
- Cannot be changed without full application restart
- No MCP tool exists to manage configuration
- Tools return static error when monitoring is disabled

## Environment

- **OS**: All platforms
- **Node.js Version**: v20.x
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: All versions
- **MCP Protocol**: Model Context Protocol v1.0

## Error Logs/Stack Trace

```typescript
// Current implementation in src/mcp/tools/event-monitoring/query-events.ts
if (!process.env.EVENT_MONITORING_ENABLED) {
  return {
    error: true,
    message: 'Event monitoring is not enabled in this environment',
    hint: 'Set EVENT_MONITORING_ENABLED=true and restart the application'
  };
}
```

## Root Cause Analysis

- **File(s)**: 
  - `src/config/index.ts` - Static environment variable reading
  - `src/mcp/state/event-monitor/sqlite-event-monitor.ts` - Initialization at startup
  - `src/mcp/tools/event-monitoring/*.ts` - Check environment at runtime
- **Cause**: 
  - Configuration is read once from environment variables at startup
  - No runtime configuration management system exists
  - Event monitor initialization is tied to application startup
  - No mechanism to start/stop event monitoring dynamically

## Proposed Solution

### 1. Create Runtime Configuration Manager

```typescript
// src/mcp/config/runtime-config-manager.ts
export class RuntimeConfigManager {
  private config: Map<string, any> = new Map();
  private eventMonitor?: SQLiteEventMonitor;
  
  constructor(private stateManager: MonitoredStateManager) {
    this.loadInitialConfig();
  }
  
  async setEventMonitoring(enabled: boolean, options?: EventMonitorOptions): Promise<void> {
    if (enabled && !this.eventMonitor) {
      // Start event monitoring
      this.eventMonitor = new SQLiteEventMonitor(options);
      await this.eventMonitor.initialize();
      this.stateManager.setEventMonitor(this.eventMonitor);
    } else if (!enabled && this.eventMonitor) {
      // Stop event monitoring
      await this.eventMonitor.close();
      this.stateManager.setEventMonitor(undefined);
      this.eventMonitor = undefined;
    }
    
    this.config.set('eventMonitoring', { enabled, ...options });
    await this.persistConfig();
  }
  
  getEventMonitoringStatus(): EventMonitoringStatus {
    return {
      enabled: !!this.eventMonitor,
      config: this.config.get('eventMonitoring'),
      statistics: this.eventMonitor?.getStatistics()
    };
  }
}
```

### 2. Create Configuration Management MCP Tool

```typescript
// src/mcp/tools/system-config.ts
export class ConfigureSystemTool extends BaseQSysTool<ConfigureSystemParams> {
  constructor(
    controlSystem: IControlSystem,
    private configManager: RuntimeConfigManager
  ) {
    super(
      controlSystem,
      'configure_system',
      'Manage system configuration at runtime including event monitoring, logging levels, and performance settings',
      ConfigureSystemParamsSchema
    );
  }
  
  protected async executeInternal(params: ConfigureSystemParams): Promise<ToolCallResult> {
    switch (params.action) {
      case 'get':
        return this.getConfiguration(params.setting);
      case 'set':
        return this.setConfiguration(params.setting, params.value);
      case 'list':
        return this.listConfigurations();
    }
  }
  
  private async setConfiguration(setting: string, value: any): Promise<ToolCallResult> {
    if (setting === 'event_monitoring') {
      await this.configManager.setEventMonitoring(
        value.enabled,
        {
          dbPath: value.dbPath || './data/events',
          retentionDays: value.retentionDays || 7,
          maxEvents: value.maxEvents || 1000000
        }
      );
      
      return {
        content: [{
          type: 'text',
          text: JSON.stringify({
            success: true,
            message: `Event monitoring ${value.enabled ? 'enabled' : 'disabled'}`,
            config: this.configManager.getEventMonitoringStatus()
          })
        }],
        isError: false
      };
    }
    // Handle other settings...
  }
}
```

### 3. Update StateManager to Support Dynamic Event Monitor

```typescript
// src/mcp/state/monitored-state-manager.ts
export class MonitoredStateManager extends StateManager {
  private eventMonitor?: IEventMonitor;
  
  setEventMonitor(monitor: IEventMonitor | undefined): void {
    this.eventMonitor = monitor;
    
    if (monitor) {
      // Re-subscribe existing change groups to new monitor
      this.changeGroups.forEach(group => {
        if (group.autoPolling) {
          monitor.subscribeToChangeGroup(group.id);
        }
      });
    }
  }
  
  getEventMonitor(): IEventMonitor | undefined {
    return this.eventMonitor;
  }
}
```

### 4. Update Event Monitoring Tools to Use Runtime Config

```typescript
// src/mcp/tools/event-monitoring/query-events.ts
protected async executeInternal(params: QueryEventsParams): Promise<ToolCallResult> {
  const eventMonitor = this.stateManager.getEventMonitor();
  
  if (!eventMonitor) {
    return {
      content: [{
        type: 'text',
        text: JSON.stringify({
          error: true,
          message: 'Event monitoring is currently disabled',
          hint: 'Use configure_system tool to enable: {"tool":"configure_system","action":"set","setting":"event_monitoring","value":{"enabled":true}}'
        })
      }],
      isError: true
    };
  }
  
  // Continue with normal query logic...
}
```

## Workaround

Current workaround requires manual intervention:
1. Stop the MCP server
2. Set environment variable: `export EVENT_MONITORING_ENABLED=true`
3. Optionally set: `export EVENT_MONITORING_DB_PATH=./data/events`
4. Restart the MCP server
5. Event monitoring tools will now work

## Test Cases

- [ ] Test enabling event monitoring via MCP tool when initially disabled
- [ ] Test disabling event monitoring via MCP tool when initially enabled
- [ ] Test that existing change groups reconnect when monitoring is enabled
- [ ] Test database file creation in specified path
- [ ] Test configuration persistence across restarts
- [ ] Test concurrent enable/disable requests are handled safely
- [ ] Test memory cleanup when monitoring is disabled
- [ ] Test error handling for invalid database paths
- [ ] Test configuration query returns accurate status

## Related Issues

- Related to: BUG-185 (Event monitoring tools unavailable due to environment configuration)
- Enhances: Event monitoring feature set
- Improves: Operational flexibility and debugging capabilities

## Additional Context

### Benefits of Runtime Configuration:
- **Operational Flexibility**: Enable monitoring on-demand for debugging
- **Resource Management**: Disable when not needed to save disk/memory
- **Better UX**: No restart required for configuration changes
- **Production Debugging**: Can enable monitoring in production without downtime
- **Consistent Interface**: All configuration through MCP tools

### Implementation Considerations:
- Configuration changes should be atomic and thread-safe
- Need to handle graceful transitions (finish writing pending events)
- Consider configuration persistence (survive restarts)
- May want to extend to other settings (log levels, performance tuning)
- Should emit events when configuration changes

### Performance Impact:
- Minimal - configuration manager adds negligible overhead
- Starting/stopping event monitor has one-time cost
- No impact when feature is stable (not being toggled)

## Acceptance Criteria

- [ ] New `configure_system` MCP tool is available and documented
- [ ] Event monitoring can be enabled at runtime without restart
- [ ] Event monitoring can be disabled at runtime without restart
- [ ] Configuration persists across application restarts
- [ ] Event monitoring tools work immediately after enabling
- [ ] No memory leaks when toggling monitoring on/off repeatedly
- [ ] Clear error messages guide users to the configuration tool
- [ ] Integration tests cover all configuration scenarios
- [ ] Documentation updated with new configuration approach

## Notes

This enhancement significantly improves operational flexibility by allowing runtime configuration management through MCP tools. It follows the pattern of keeping all control through the MCP interface rather than requiring environment variable changes and restarts.

The solution is extensible - the same configuration manager can handle other runtime settings like logging levels, performance tuning parameters, and feature flags in the future.

Priority is Medium because current workaround exists (restart with env var), but the improvement would significantly enhance user experience and operational capabilities.

---

**Labels**: enhancement, event-monitoring, mcp-tools, configuration, runtime-management  
**Milestone**: v2.1.0 - Enhanced Configuration Management