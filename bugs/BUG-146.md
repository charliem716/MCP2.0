# BUG-146: SecurityHeadersProvider uses try-catch workaround for logger creation

**Status**: Open  
**Severity**: High  
**Priority**: P1 (High)  
**Component**: mcp/middleware/security  
**Reported Date**: 2025-01-31  
**Reporter**: Assistant  
**Assignee**: Unassigned

## Summary

The SecurityHeadersProvider class uses a try-catch block with a manual fallback when creating its logger, indicating existing testing issues that should be resolved with proper dependency injection.

## Description

The `SecurityHeadersProvider` class in `src/mcp/middleware/security.ts` attempts to create a logger with a try-catch block and provides a manual fallback implementation. This pattern:

- Indicates existing problems with test mocking
- Creates maintenance burden with manual fallback logger
- Shows the class already knows it has testing issues
- Makes the code less clean and harder to understand

## Steps to Reproduce

1. Look at the SecurityHeadersProvider constructor
2. Observe the try-catch block around logger creation
3. Note the manual fallback logger implementation
4. Run tests that instantiate SecurityHeadersProvider
5. Tests likely use the fallback logger instead of proper mocks

## Expected Behavior

SecurityHeadersProvider should accept an optional logger instance through dependency injection, eliminating the need for try-catch workarounds.

## Actual Behavior

SecurityHeadersProvider tries to create a logger and catches exceptions, providing a manual no-op logger implementation as a fallback for test environments.

## Environment

- **OS**: All
- **Node.js Version**: v20+
- **Project Version/Commit**: Current main branch
- **Jest Version**: 29.x with ES modules

## Error Logs/Stack Trace

```typescript
// Current problematic code with workaround
constructor(config: SecurityConfig = {}) {
  try {
    this.logger = createLogger('mcp-security');
  } catch {
    // Fallback for test environment
    this.logger = {
      info: () => {},
      error: () => {},
      warn: () => {},
      debug: () => {},
      child: () => this.logger,
    } as Logger;
  }
  // ...
}
```

## Root Cause Analysis

- **File(s)**: src/mcp/middleware/security.ts
- **Line(s)**: Lines 52-62
- **Cause**: Direct logger creation with hacky workaround instead of proper dependency injection

## Proposed Solution

```typescript
// Add logger to config interface
export interface SecurityConfig {
  enabled?: boolean;
  logger?: Logger; // Add optional logger
  // ... existing config options
  csp?: { /* ... */ };
  cors?: { /* ... */ };
  hsts?: { /* ... */ };
}

// Update constructor to use injected logger or create default
constructor(config: SecurityConfig = {}) {
  this.logger = config.logger ?? createLogger('mcp-security');
  
  this.config = {
    enabled: config.enabled ?? true,
    // ... rest of config initialization
  };
  
  // Remove the try-catch workaround entirely
}
```

## Workaround

The code already contains its own workaround (the try-catch with fallback), but this should be replaced with proper DI.

## Test Cases

- [ ] Unit test with mock logger injection
- [ ] Unit test with default logger creation
- [ ] Verify all logger methods are called correctly
- [ ] Test security header generation with custom logger
- [ ] Ensure no try-catch needed in new implementation

## Related Issues

- Related to: BUG-141 (Hanging tests due to module mocking)
- Related to: BUG-145 (GlobalErrorHandler DI refactoring)
- Part of: DI refactoring initiative

## Additional Context

- The existing try-catch pattern shows this has been a known problem
- Removing the workaround will make the code cleaner and more maintainable
- This is a high-priority fix because the workaround indicates active testing problems

## Acceptance Criteria

- [ ] SecurityHeadersProvider accepts optional logger in config
- [ ] Try-catch workaround is completely removed
- [ ] Tests can inject mock loggers successfully
- [ ] No breaking changes to existing API
- [ ] All existing tests pass without the fallback logger

## Notes

The presence of the try-catch workaround makes this a high priority - it shows the current approach is already problematic and needs proper fixing.

---

**Labels**: bug, refactoring, testing, dependency-injection, technical-debt  
**Milestone**: Test Infrastructure Improvement