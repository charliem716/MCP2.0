# BUG-035: Parameter Format Incompatibility with Q-SYS API Specification

**Severity**: Medium  
**Status**: Open  
**Component**: QRWC Adapter  
**Phase**: 2  
**Date**: 2024-01-20  

## Description
The current implementation expects parameters in a different format than the Q-SYS API specification. The API spec shows direct array parameters for some methods, while our implementation expects them wrapped in an object with named properties.

## Location
`src/mcp/qrwc/adapter.ts` - Parameter parsing in executeCommand method

## Examples of Incompatibility

### 1. Control.Get Method
**API Specification**:
```json
{
  "jsonrpc": "2.0",
  "id": 1234,
  "method": "Control.Get",
  "params": ["MainGain", "MainMute"]  // Direct array
}
```

**Current Implementation Expects**:
```json
{
  "jsonrpc": "2.0",
  "id": 1234,
  "method": "Control.GetValues",
  "params": {
    "Controls": ["MainGain", "MainMute"]  // Wrapped in object
  }
}
```

### 2. Control.Set Method
**API Specification** (Single control):
```json
{
  "jsonrpc": "2.0",
  "id": 1234,
  "method": "Control.Set",
  "params": {
    "Name": "MainGain",
    "Value": -12,
    "Ramp": 2.0
  }
}
```

**Current Implementation Expects** (Array of controls):
```json
{
  "jsonrpc": "2.0",
  "id": 1234,
  "method": "Control.SetValues",
  "params": {
    "Controls": [{
      "Name": "MainGain",
      "Value": -12,
      "Ramp": 2.0
    }]
  }
}
```

## Root Cause
The implementation follows the QRWC WebSocket conventions rather than the original QRC TCP protocol conventions, creating parameter format differences.

## Proposed Solution
Support both parameter formats for maximum compatibility:

```typescript
case "Control.Get":
case "Control.GetValues":
case "ControlGetValues":
case "Control.GetMultiple":
  let controlsList;
  
  // Support both formats
  if (Array.isArray(params)) {
    // Direct array format (API spec)
    controlsList = params;
  } else if (params?.['Controls']) {
    // Object wrapped format (current)
    controlsList = params['Controls'];
  } else if (params?.['Names']) {
    // Alternative naming
    controlsList = params['Names'];
  } else {
    controlsList = [];
  }
  
  // Continue with existing logic...

case "Control.Set":
case "Control.SetValues":
case "ControlSetValues":
  let setControls;
  
  // Support both single control and array formats
  if (params?.['Controls']) {
    // Current array format
    setControls = Array.isArray(params['Controls']) ? params['Controls'] : [params['Controls']];
  } else if (params?.['Name'] && params?.['Value'] !== undefined) {
    // Single control format (API spec)
    setControls = [{
      Name: params['Name'],
      Value: params['Value'],
      Ramp: params['Ramp']
    }];
  } else {
    throw new Error("Invalid parameters for Control.Set");
  }
  
  // Continue with existing logic...
```

## Benefits
- Full compatibility with Q-SYS API specification
- Supports existing clients without breaking changes
- Handles both QRC and QRWC parameter conventions
- More flexible parameter parsing

## Test Requirements
1. Test Control.Get with direct array parameters
2. Test Control.Get with object-wrapped parameters
3. Test Control.Set with single control parameters
4. Test Control.Set with array of controls
5. Verify backward compatibility with existing code
6. Test error handling for invalid parameter formats