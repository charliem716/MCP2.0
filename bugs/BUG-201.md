# BUG-201: Ramp Parameter Not Functional Due to Official SDK Limitation

## Summary
The `ramp` parameter in the `set_control_values` MCP tool is accepted syntactically but does not produce the expected smooth transition behavior. Control values jump immediately to the target value instead of ramping over the specified duration.

## Root Cause Analysis

### Issue
The ramp functionality fails because:

1. **SDK Limitation**: The official `@q-sys/qrwc` TypeScript SDK does not support ramp parameters in its `control.update()` method
2. **Interface Mismatch**: The SDK's `IComponentSetRequest` interface only supports:
   - `Name`: Component name
   - `Controls`: Array with `Name` and `Value` properties
   - `ResponseValues`: Boolean flag
   - **No `Ramp` parameter is defined**

3. **Implementation Gap**: Our code preserves the ramp parameter through the pipeline but ultimately calls `control.update(value)` which only accepts a value, not ramp timing

### Code Analysis

#### Current Flow
1. MCP tool accepts: `{name: 'Control', value: -40, ramp: 5}`
2. Controls.ts preserves ramp in the command structure
3. Command-handlers.ts calls `client.setControlValue(componentName, controlName, value)`
4. OfficialClient.ts calls `control.update(value)` - **ramp is lost here**
5. The official SDK sends the update without any ramp information

#### SDK Interface Definition
From `node_modules/@q-sys/qrwc/dist/esm/index.interface.d.ts`:
```typescript
export interface IComponentSetRequest {
    ResponseValues: boolean;
    Name: string;
    Controls: {
        Name: string;
        Value: string | number | boolean;
        // No Ramp property available
    }[];
}
```

## Test Results
Test 2.3 from master-test-prompts.md:
- **Original Value**: -23
- **Target Value**: -40  
- **Ramp Duration**: 5 seconds
- **Actual Behavior**: Value jumped immediately to -40
- **Expected Behavior**: Gradual transition over 5 seconds

## Constraints
Per project requirements:
- We must use only functions officially supported by the `@q-sys/qrwc` TypeScript SDK
- The `sendRawCommand` function exists but has been "highly limited" and should not be used for standard operations
- We cannot bypass the SDK to send custom protocol commands

## Resolution Options

### Option 1: Document as Known Limitation (Recommended)
- Update tool documentation to clarify ramp is accepted but non-functional
- Add warning in code comments
- Keep parameter for future SDK compatibility

### Option 2: Remove Ramp Parameter
- Remove ramp from the Zod schema
- Clean up all references in the codebase
- Update tests to not expect ramp functionality

### Option 3: Wait for SDK Update
- Contact Q-SYS/QSC to request ramp support in the official SDK
- Keep current implementation as placeholder
- Document limitation clearly

## Recommendation
**Option 1** is recommended. The ramp parameter should remain in our API for forward compatibility, but we should clearly document that it's currently non-functional due to SDK limitations. This allows:
- API stability for users
- Easy activation when/if SDK adds support
- Clear communication about current limitations

## Code Changes Made
Updated documentation in `src/mcp/tools/controls.ts` to clarify the limitation:
```typescript
// Line 92: Added comment explaining ramp parameter limitation
ramp: z.coerce.number().positive().optional()
  .describe('Ramp time in seconds (NOTE: Currently non-functional due to SDK limitation)'),
```

## Testing
No additional tests needed as this documents existing behavior rather than changing it.

## Impact
- Users expecting smooth transitions will see immediate value changes
- This is a limitation of the underlying SDK, not our implementation
- Functionality will remain ready for when/if the SDK adds support

## Update: sendRawCommand Investigation (2025-08-11)

### Comprehensive Testing Results
We thoroughly tested `sendRawCommand` to determine if it could bypass SDK limitations:

#### Test Methodology
1. Direct WebSocket connection to Q-SYS Core
2. sendRawCommand after SDK connection
3. Various command formats including Control.Set with Ramp

#### Results: sendRawCommand is NON-FUNCTIONAL
- **All raw commands timeout** - Q-SYS doesn't respond to raw JSON-RPC messages
- **Protocol mismatch** - SDK uses proprietary protocol, not standard JSON-RPC
- **Cannot bypass SDK** - Raw commands are ignored by Q-SYS Core

#### Critical Finding
```
sendRawCommand exists in the code but DOES NOT WORK.
Q-SYS requires the SDK's proprietary protocol handling.
Raw WebSocket commands are completely ignored.
```

## Status
**PERMANENTLY BLOCKED** - Cannot be fixed without official SDK support. Do not attempt workarounds.