# BUG-180: MCP Server Fails to Connect in Claude Desktop

## Status: OPEN
**Severity**: Critical  
**Component**: MCP Server / Claude Desktop Integration  
**Reported**: 2025-08-08  
**Reporter**: System  

## Description
The MCP server fails to establish and maintain a connection with Claude Desktop. The server shows as "Failed" in Claude Desktop UI despite the server process starting successfully and responding correctly to JSON-RPC protocol messages when tested manually.

## Symptoms
1. Claude Desktop shows "Server Disconnected" error on startup
2. Server status shows as "Failed" in Claude Desktop
3. Logs indicate "Server transport closed unexpectedly, this is likely due to the process exiting early"
4. Server actually responds correctly to JSON-RPC initialize requests when tested manually
5. Large log file generated (651MB+) suggesting repeated connection attempts

## Current Behavior
- Server starts and runs without errors
- Server correctly responds to initialize request with proper JSON-RPC response
- Server process stays alive when run manually
- Server appears to exit immediately when started by Claude Desktop

## Expected Behavior
- Server should connect to Claude Desktop successfully
- Server should remain connected and responsive
- Server should handle stdio transport correctly for bidirectional communication

## Investigation Findings

### What Works
1. **Manual Testing**: Server responds correctly to JSON-RPC protocol
   ```bash
   echo '{"jsonrpc": "2.0", "method": "initialize", "params": {"protocolVersion": "0.1.0", "capabilities": {}, "clientInfo": {"name": "test", "version": "1.0.0"}}, "id": 1}' | MCP_MODE=true NODE_ENV=production node dist/index.js
   # Returns valid response: {"result":{"protocolVersion":"2025-06-18","capabilities":{"tools":{},"resources":{},"prompts":{},"logging":{}},"serverInfo":{"name":"qsys-mcp-server","version":"1.0.0"}},"jsonrpc":"2.0","id":1}
   ```

2. **Process Lifecycle**: Server process stays alive when run directly
   ```bash
   MCP_MODE=true NODE_ENV=production node dist/index.js &
   # Process remains running with PID
   ```

3. **SDK Validation**: MCP SDK works correctly with minimal test server
   ```javascript
   // Minimal server responds correctly
   const server = new Server(
     { name: 'test-server', version: '1.0.0' },
     { capabilities: { tools: {} } }
   );
   const transport = new StdioServerTransport();
   await server.connect(transport);
   ```

### Issues Identified and Fixed
1. **Top-level awaits**: Removed from `env.ts` and `index.ts` - these were blocking module loading
2. **process.stdin.resume()**: Moved to prevent interference with StdioServerTransport
3. **Synchronous file I/O**: ConfigManager uses `fs.readFileSync` but this doesn't appear to be the root cause

### Configuration
Claude Desktop config (`/Users/charliemccarrel/Library/Application Support/Claude/claude_desktop_config.json`):
```json
{
  "mcpServers": {
    "qsys": {
      "command": "node",
      "args": ["/Users/charliemccarrel/Desktop/Builds/MCP2.0/dist/index.js"],
      "env": {
        "NODE_ENV": "production",
        "MCP_MODE": "true",
        "EVENT_MONITORING_ENABLED": "true",
        "EVENT_MONITORING_DB_PATH": "/Users/charliemccarrel/Desktop/Builds/MCP2.0/data/events",
        "EVENT_MONITORING_RETENTION_DAYS": "7",
        "EVENT_MONITORING_BUFFER_SIZE": "1000",
        "EVENT_MONITORING_FLUSH_INTERVAL": "100"
      }
    }
  }
}
```

### Error Logs
From `/Users/charliemccarrel/Library/Logs/Claude/mcp-server-qsys.log`:
```
2025-08-08T17:51:50.910Z [qsys] [info] Server started and connected successfully
2025-08-08T17:51:50.925Z [qsys] [info] Message from client: {"method":"initialize","params":{"protocolVersion":"2025-06-18","capabilities":{},"clientInfo":{"name":"claude-ai","version":"0.1.0"}},"jsonrpc":"2.0","id":0}
2025-08-08T17:51:51.276Z [qsys] [info] Server transport closed
2025-08-08T17:51:51.276Z [qsys] [info] Server transport closed unexpectedly, this is likely due to the process exiting early
```

## Root Cause Analysis Needed
1. **Why does the server exit after receiving initialize?**
   - Server responds correctly when tested manually
   - Process stays alive when run directly
   - Something specific about Claude Desktop's stdio handling causes early exit

2. **Timing/Race Condition?**
   - Server takes time to initialize (async operations in factory)
   - May be missing keepalive mechanism after response

3. **Stdio Transport Handling**
   - Possible issue with how server handles stdio when launched by Claude Desktop
   - May need specific handling for keeping process alive after initial response

4. **Event Loop Blocking**
   - Despite removing top-level awaits, something may still be blocking
   - Need to investigate what happens after server.connect(transport)

## Attempted Solutions That Failed
1. Removing top-level awaits - helped but didn't solve the disconnect
2. Moving process.stdin.resume() - helped but didn't solve the disconnect
3. Creating wrapper scripts - complicated the solution unnecessarily
4. Adding debug logging - server starts but still disconnects

## Next Steps Required
1. **Deep dive into stdio transport lifecycle**
   - Understand how StdioServerTransport handles the connection
   - Check if server needs to explicitly keep stdin open after responding

2. **Compare with working MCP servers**
   - Analyze successful MCP server implementations
   - Identify differences in stdio handling

3. **Add connection persistence logic**
   - Ensure server doesn't exit after sending response
   - May need to handle 'initialized' notification from client

4. **Test with minimal implementation**
   - Strip down to bare minimum that works
   - Gradually add components to identify breaking point

## Reproduction Steps
1. Install dependencies: `npm install`
2. Build the project: `npm run build`
3. Configure Claude Desktop with the above config
4. Restart Claude Desktop
5. Observe "Server Disconnected" error

## Environment
- Node.js: v22.14.0
- MCP SDK: @modelcontextprotocol/sdk (latest)
- Claude Desktop: Latest version
- OS: macOS (Darwin 24.5.0)
- Working Directory: /Users/charliemccarrel/Desktop/Builds/MCP2.0

## Related Issues
- Previous dynamic tools implementation (removed)
- Event monitoring restoration (BUG-150)
- Configuration fragmentation (BUG-133)

## Priority
This is a critical blocker preventing the MCP server from being usable in Claude Desktop. The server functionality is complete and working, but the connection issue prevents any actual usage.

## Notes
- The server implementation is correct and follows MCP protocol
- The issue appears to be specific to how Claude Desktop manages the stdio connection
- Manual testing confirms the server logic is sound
- Need to focus on connection lifecycle management rather than protocol implementation