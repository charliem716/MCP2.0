# BUG-075: Missing gte/lte operators in Event Cache query engine

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: State Management / Event Cache  
**Reported Date**: 2025-07-23  
**Reporter**: System Analysis  
**Assignee**: Unassigned  

## Summary
The Event Cache query engine is missing greater-than-or-equal (gte) and less-than-or-equal (lte) operators, limiting query capabilities for range-based searches.

## Description
The EventQuery interface only supports gt (>) and lt (<) operators for numeric comparisons, but not gte (>=) and lte (<=). This makes it impossible to:
- Query for values at or above a threshold
- Find events where a level reached exactly -6dB
- Implement proper range queries with inclusive bounds
- Match common query patterns used in monitoring systems

This is particularly problematic for Q-SYS control values where exact thresholds are important (e.g., "alert when SPL >= 85dB").

## Steps to Reproduce
1. Create an EventCacheManager and add events with numeric values
2. Try to query for events where value >= 0.5
3. Observe that only gt (>) is available, requiring value > 0.4999999
4. Try to find events where value = 0.5 OR value > 0.5
5. Notice this requires two separate queries

## Expected Behavior
The query engine should support:
- `gte`: Greater than or equal to
- `lte`: Less than or equal to
- These operators should work correctly with numeric values
- Type checking should ensure values are numeric before comparison

## Actual Behavior
- Only `gt` and `lt` operators are available
- Developers must use workarounds with slightly adjusted values
- Cannot express inclusive range queries naturally
- No way to combine "equal to or greater than" in a single query

## Environment
- **OS**: All
- **Node.js Version**: v20.11.0+
- **Project Version/Commit**: Current main branch

## Error Logs/Stack Trace
```typescript
// From src/mcp/state/event-cache/manager.ts:39
valueFilter?: {
  operator: 'eq' | 'neq' | 'gt' | 'lt' | 'changed_to' | 'changed_from';
  value?: unknown;
} | undefined;
```

## Root Cause Analysis
- **File(s)**: src/mcp/state/event-cache/manager.ts
- **Line(s)**: 39 (EventQuery interface), 318-326 (applyValueFilter implementation)
- **Cause**: The operators were not included in the initial implementation

## Proposed Solution
```typescript
// Update EventQuery interface
export interface EventQuery {
  // ... existing fields ...
  valueFilter?: {
    operator: 'eq' | 'neq' | 'gt' | 'gte' | 'lt' | 'lte' | 'changed_to' | 'changed_from';
    value?: unknown;
  } | undefined;
}

// Update applyValueFilter method
private applyValueFilter(
  events: CachedEvent[], 
  filter: EventQuery['valueFilter']
): CachedEvent[] {
  if (!filter || filter.value === undefined) return events;
  
  const { operator, value } = filter;
  
  return events.filter(event => {
    switch (operator) {
      case 'eq': 
        return event.value === value;
        
      case 'neq': 
        return event.value !== value;
        
      case 'gt': 
        return typeof event.value === 'number' && 
               typeof value === 'number' && 
               event.value > value;
               
      case 'gte': 
        return typeof event.value === 'number' && 
               typeof value === 'number' && 
               event.value >= value;
               
      case 'lt': 
        return typeof event.value === 'number' && 
               typeof value === 'number' && 
               event.value < value;
               
      case 'lte': 
        return typeof event.value === 'number' && 
               typeof value === 'number' && 
               event.value <= value;
               
      case 'changed_to': 
        return event.value === value && 
               event.previousValue !== undefined &&
               event.previousValue !== value;
               
      case 'changed_from':
        return event.previousValue !== undefined &&
               event.previousValue === value && 
               event.value !== value;
               
      default: 
        return true;
    }
  });
}

// Also update the MCP tool schema
const ReadChangeGroupEventsParamsSchema = z.object({
  // ... existing fields ...
  valueFilter: z.object({
    operator: z.enum(['eq','neq','gt','gte','lt','lte','changed_to','changed_from']),
    value: z.unknown()
  }).optional()
});
```

## Workaround
Use gt/lt with adjusted values (e.g., use > 0.4999 instead of >= 0.5), though this is imprecise and doesn't work for integer values.

## Test Cases
- [ ] Unit test: gte operator with exact boundary value
- [ ] Unit test: lte operator with exact boundary value  
- [ ] Unit test: gte/lte with integer values
- [ ] Unit test: gte/lte with floating point values
- [ ] Unit test: gte/lte with non-numeric values (should not match)
- [ ] Integration test: Query combining gte and lte for range

## Related Issues
- Related to: BUG-072 (Event Cache Manager implementation)
- Related to: Phase 1.3 Query Engine requirements

## Additional Context
- This is a common requirement for monitoring thresholds
- Many Q-SYS controls use exact threshold values (0dB, -6dB, etc.)
- The implementation is straightforward and low risk

## Acceptance Criteria
- [ ] gte and lte operators are available in EventQuery
- [ ] Operators work correctly with numeric comparisons
- [ ] MCP tool schema includes new operators
- [ ] Type checking prevents comparison of non-numeric values
- [ ] Documentation updated with operator examples
- [ ] All tests pass

## Notes
While marked as Medium priority, this significantly impacts usability for common monitoring scenarios. The fix is simple and should be included before GA.

---
**Labels**: bug, event-cache, query-engine, medium-priority  
**Milestone**: Event Cache GA