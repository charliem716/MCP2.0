# BUG-182: set_control_values tool not implemented in QRWC adapter

**Status**: Open  
**Severity**: Critical  
**Priority**: P0 (Emergency)  
**Component**: QRWC Adapter / MCP Tools  
**Reported Date**: 2025-08-08  
**Reporter**: System Validation  
**Assignee**: Unassigned

## Summary

The `qsys:set_control_values` MCP tool fails with "Unknown QRWC command: Component.Set" error, completely preventing control manipulation through the MCP interface.

## Description

The set_control_values tool is the primary mechanism for modifying Q-SYS control values through the MCP interface. The complete absence of this functionality means the system cannot perform any control changes, severely limiting its usefulness as a control system interface. This is a critical gap that makes the MCP server read-only.

- What is happening: Tool throws "Unknown QRWC command" error
- What should happen: Tool should set control values and return confirmation
- Impact: Cannot modify any Q-SYS controls, rendering the system read-only
- Error message: "Unknown QRWC command: Component.Set"

## Steps to Reproduce

1. Connect to Q-SYS Core using MCP server
2. Call `qsys:set_control_values` tool with valid parameters:
   ```json
   {
     "componentName": "Main Input Gain",
     "controls": [
       {
         "name": "gain",
         "value": -5.0
       },
       {
         "name": "mute",
         "value": 1
       }
     ]
   }
   ```
3. Expected result: Controls are updated and confirmation returned
4. Actual result: Error "Unknown QRWC command: Component.Set"

## Expected Behavior

The tool should update the specified control values and return confirmation:
```json
{
  "success": true,
  "message": "Successfully set 2 control values for component 'Main Input Gain'",
  "updatedControls": [
    {
      "name": "gain",
      "value": -5.0,
      "string": "-5.0dB"
    },
    {
      "name": "mute", 
      "value": 1,
      "string": "muted"
    }
  ]
}
```

## Actual Behavior

Tool returns an error:
```json
{
  "error": "Unknown QRWC command: Component.Set"
}
```

## Environment

- **OS**: macOS (from validation report)
- **Node.js Version**: v20.x
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: Designer environment (MCP-Demo-67-Components)
- **MCP Server**: Running with stdio transport

## Error Logs/Stack Trace

```
Error: Unknown QRWC command: Component.Set
    at QRWCAdapter.executeCommand (src/qrwc/qrwcAdapter.ts)
    at SetControlValuesHandler.execute (src/mcp/tools/handlers/set-control-values.ts)
```

## Root Cause Analysis

- **File(s)**: src/qrwc/qrwcAdapter.ts
- **Line(s)**: executeCommand method switch statement
- **Cause**: The QRWC adapter's executeCommand method does not handle the 'Component.Set' case. This is the most critical missing feature as it prevents any control manipulation.

## Proposed Solution

Implement the `Component.Set` command in the QRWC adapter using the official SDK's control setting methods:

```typescript
// In qrwcAdapter.ts executeCommand method
case 'Component.Set':
  const componentName = params.Name as string;
  const controls = params.Controls as Array<{Name: string, Value?: number, Position?: number}>;
  
  const component = await this.client.getComponent(componentName);
  const results = await Promise.all(
    controls.map(async (control) => {
      const qControl = component.getControl(control.Name);
      if (control.Value !== undefined) {
        await qControl.setValue(control.Value);
      } else if (control.Position !== undefined) {
        await qControl.setPosition(control.Position);
      }
      return {
        Name: control.Name,
        Value: qControl.value,
        Position: qControl.position,
        String: qControl.stringValue
      };
    })
  );
  
  return { 
    Success: true,
    Controls: results
  };
```

## Workaround

Currently **no workaround exists** for setting control values through the MCP interface. This is a complete functionality gap that requires implementation.

## Test Cases

- [ ] Unit test for Component.Set command in adapter
- [ ] Integration test for set_control_values with single control by value
- [ ] Integration test for set_control_values with single control by position
- [ ] Integration test for set_control_values with multiple controls
- [ ] Edge case: Invalid component name
- [ ] Edge case: Invalid control name
- [ ] Edge case: Out-of-range values
- [ ] Edge case: Read-only controls
- [ ] Regression test: Ensure control monitoring still works after changes

## Related Issues

- Related to: BUG-181 (get_control_values implementation)
- Blocks: Any automation or control features
- Critical for: Production deployment

## Additional Context

- **This is the most critical bug** preventing the MCP server from being a functional control interface
- Without this feature, the system is essentially read-only
- Implementation must handle both value and position setting methods
- Must properly handle control constraints (min/max values, discrete values)
- Consider implementing optimistic updates with rollback on failure
- Security implications: Ensure proper authorization for control changes

## Acceptance Criteria

- [ ] set_control_values tool successfully modifies control values
- [ ] Tool handles both value and position setting methods
- [ ] Tool validates control constraints before attempting changes
- [ ] Error handling for invalid controls or values
- [ ] Changes are immediately reflected in change group polls
- [ ] Performance is acceptable (<500ms for typical requests)
- [ ] All test cases pass
- [ ] Documentation updated with usage examples and security considerations

## Notes

This is marked as P0 Emergency priority because without control manipulation, the MCP server cannot fulfill its primary purpose as a control interface. This should be the top implementation priority.

---

**Labels**: bug, qrwc-adapter, mcp-tools, critical, blocker  
**Milestone**: MVP Functionality