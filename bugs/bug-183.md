# BUG-183: remove_controls_from_change_group not implemented in QRWC adapter

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: QRWC Adapter / Change Group Management  
**Reported Date**: 2025-08-08  
**Reporter**: System Validation  
**Assignee**: Unassigned

## Summary

The `qsys:remove_controls_from_change_group` MCP tool fails with "Unknown QRWC command: ChangeGroup.Remove" error, preventing selective removal of controls from change groups.

## Description

The remove_controls_from_change_group tool should allow users to selectively remove specific controls from an existing change group without destroying the entire group. This functionality is important for dynamic monitoring scenarios where the set of monitored controls needs to be adjusted during runtime. Currently, the only way to modify a change group is to destroy and recreate it.

- What is happening: Tool throws "Unknown QRWC command" error
- What should happen: Tool should remove specified controls from the change group
- Impact: Cannot dynamically adjust monitored controls without recreating groups
- Error message: "Unknown QRWC command: ChangeGroup.Remove"

## Steps to Reproduce

1. Connect to Q-SYS Core using MCP server
2. Create a change group and add controls to it
3. Call `qsys:remove_controls_from_change_group` tool:
   ```json
   {
     "groupId": "group_123",
     "controlNames": ["Main Input Gain.gain"]
   }
   ```
4. Expected result: Control is removed from the change group
5. Actual result: Error "Unknown QRWC command: ChangeGroup.Remove"

## Expected Behavior

The tool should remove the specified controls and return confirmation:
```json
{
  "success": true,
  "message": "Removed 1 control from change group",
  "remainingControls": 5
}
```

## Actual Behavior

Tool returns an error:
```json
{
  "error": "Unknown QRWC command: ChangeGroup.Remove"
}
```

## Environment

- **OS**: macOS (from validation report)
- **Node.js Version**: v20.x
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: Designer environment (MCP-Demo-67-Components)
- **MCP Server**: Running with stdio transport

## Error Logs/Stack Trace

```
Error: Unknown QRWC command: ChangeGroup.Remove
    at QRWCAdapter.executeCommand (src/qrwc/qrwcAdapter.ts)
    at RemoveControlsFromChangeGroupHandler.execute (src/mcp/tools/handlers/remove-controls-from-change-group.ts)
```

## Root Cause Analysis

- **File(s)**: src/qrwc/qrwcAdapter.ts
- **Line(s)**: executeCommand method switch statement
- **Cause**: The QRWC adapter does not implement the 'ChangeGroup.Remove' command. The adapter currently only supports basic change group operations (create, add, poll, destroy).

## Proposed Solution

Implement the `ChangeGroup.Remove` command in the QRWC adapter:

```typescript
// In qrwcAdapter.ts executeCommand method
case 'ChangeGroup.Remove':
  const groupId = params.Id as string;
  const controlNames = params.Controls as string[];
  
  const changeGroup = this.changeGroups.get(groupId);
  if (!changeGroup) {
    throw new Error(`Change group ${groupId} not found`);
  }
  
  // Remove controls from the SDK's change group
  for (const controlName of controlNames) {
    await changeGroup.removeControl(controlName);
  }
  
  // Update internal tracking
  const groupInfo = this.changeGroupInfo.get(groupId);
  if (groupInfo) {
    groupInfo.controls = groupInfo.controls.filter(
      c => !controlNames.includes(c)
    );
  }
  
  return {
    Success: true,
    RemainingControls: groupInfo?.controls.length || 0
  };
```

## Workaround

To modify the controls in a change group:
1. Call `list_change_groups` to get current controls
2. Destroy the existing change group
3. Create a new change group
4. Add only the desired controls (excluding ones to remove)
5. Re-enable auto-poll if it was previously enabled

This workaround is inefficient and may cause brief monitoring gaps.

## Test Cases

- [ ] Unit test for ChangeGroup.Remove command in adapter
- [ ] Integration test removing single control from group
- [ ] Integration test removing multiple controls from group
- [ ] Edge case: Remove non-existent control from group
- [ ] Edge case: Remove from non-existent group
- [ ] Edge case: Remove all controls from group
- [ ] Verify auto-poll continues working after removal
- [ ] Regression test: Other change group operations still work

## Related Issues

- Related to: BUG-184 (clear_change_group implementation)
- Part of: Change group management feature set

## Additional Context

- This is a quality-of-life feature that improves change group management
- Important for dynamic monitoring scenarios
- Should maintain consistency with existing change group operations
- Consider whether removing all controls should auto-destroy the group

## Acceptance Criteria

- [ ] remove_controls_from_change_group successfully removes specified controls
- [ ] Change group continues functioning after control removal
- [ ] Auto-poll continues if enabled
- [ ] Proper error handling for edge cases
- [ ] Performance is acceptable (<200ms for typical requests)
- [ ] All test cases pass
- [ ] Documentation updated with usage examples

## Notes

While not critical for basic functionality, this feature significantly improves the usability of change groups for dynamic monitoring scenarios. Consider implementing alongside BUG-184 for complete change group management.

---

**Labels**: bug, qrwc-adapter, change-groups, medium-priority  
**Milestone**: Enhanced Change Group Management