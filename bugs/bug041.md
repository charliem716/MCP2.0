# BUG-041: Missing Generic QRWC Send Tool for Direct Command Access

**Severity**: High  
**Status**: Open  
**Component**: MCP Tools  
**Phase**: 2  
**Date**: 2024-01-20  

## Description
While specific tools exist for common operations, there is no generic tool that allows AI agents to send arbitrary QRWC commands. This limits flexibility and prevents access to commands that may be implemented in the adapter but don't have dedicated tools. This is especially important for testing, debugging, and accessing future Q-SYS API additions.

## Current State
- **Implemented**: Full QRWC adapter with many commands
- **Implemented**: `sendCommand` method on adapter
- **Missing**: Generic MCP tool to send any command

## Expected Behavior
AI agents should be able to send any QRWC command:
```javascript
await callTool('qsys_send_command', {
  command: 'Snapshot.Load',
  params: {
    Name: 'MyBank',
    Bank: 1,
    Ramp: 2.5
  }
});

// Or for future/undocumented commands
await callTool('qsys_send_command', {
  command: 'Mixer.SetCrosspoint',
  params: {
    Input: 1,
    Output: 3,
    Value: true
  }
});
```

## Proposed Implementation

### File: src/mcp/tools/direct.ts (new file)
```typescript
import { z } from "zod";
import { BaseQSysTool, BaseToolParamsSchema } from "./base.js";
import type { ToolCallResult } from "../handlers/index.js";
import type { ToolExecutionContext } from "./base.js";

export const SendCommandParamsSchema = BaseToolParamsSchema.extend({
  command: z.string().describe("The QRWC command to send (e.g., 'Snapshot.Load', 'Control.Set')"),
  params: z.record(z.any()).optional().describe("Parameters for the command as a JSON object")
});

export type SendCommandParams = z.infer<typeof SendCommandParamsSchema>;

export class SendCommandTool extends BaseQSysTool<SendCommandParams> {
  constructor(qrwcClient: any) {
    super(
      qrwcClient,
      "qsys_send_command",
      "Send a raw QRWC command directly to Q-SYS Core (advanced use)",
      SendCommandParamsSchema
    );
  }

  protected async executeInternal(
    params: SendCommandParams,
    context: ToolExecutionContext
  ): Promise<ToolCallResult> {
    try {
      // Log for debugging
      context.logger?.debug("Sending raw QRWC command", {
        command: params.command,
        params: params.params
      });

      const response = await this.qrwcClient.sendCommand(
        params.command,
        params.params || {}
      );

      // Format response based on command type
      let resultText = `Command '${params.command}' executed successfully`;
      
      if (response?.result !== undefined) {
        if (typeof response.result === 'boolean') {
          resultText += `: ${response.result}`;
        } else if (typeof response.result === 'object') {
          resultText += `:\n${JSON.stringify(response.result, null, 2)}`;
        } else {
          resultText += `: ${response.result}`;
        }
      }

      return {
        content: [
          {
            type: "text",
            text: resultText
          }
        ]
      };
    } catch (error) {
      // Enhanced error reporting for debugging
      const errorDetails = {
        command: params.command,
        params: params.params,
        error: error instanceof Error ? error.message : String(error)
      };

      throw this.createToolError(
        `QRWC command failed: ${errorDetails.error}`,
        errorDetails
      );
    }
  }
}

export const createSendCommandTool = (qrwcClient: any) => 
  new SendCommandTool(qrwcClient);
```

### Update: src/mcp/handlers/index.ts
```typescript
import { createSendCommandTool } from "../tools/direct.js";

// In registerQSysTools():
const qsysTools: Array<BaseQSysTool<any>> = [
  createListComponentsTool(this.qrwcClient),
  createGetComponentControlsTool(this.qrwcClient),
  createListControlsTool(this.qrwcClient),
  createGetControlValuesTool(this.qrwcClient),
  createSetControlValuesTool(this.qrwcClient),
  createQueryCoreStatusTool(this.qrwcClient),
  createLoadSnapshotTool(this.qrwcClient),
  createSaveSnapshotTool(this.qrwcClient),
  createGetAllControlsTool(this.qrwcClient),
  createSendCommandTool(this.qrwcClient), // ADD THIS
];
```

## Benefits
- Provides access to all current and future QRWC commands
- Enables testing and debugging of Q-SYS integration
- Allows AI agents to use undocumented or custom commands
- Future-proof solution for API additions
- Eliminates need to create individual tools for every command

## Security Considerations
- This tool provides direct access to Q-SYS Core
- Should log all commands for audit trail
- Consider adding command whitelist/blacklist in future
- Document that this is for "advanced use"

## Test Requirements
1. Test with known commands (Snapshot.Load, Control.Set, etc.)
2. Test with invalid command names
3. Test with missing required parameters
4. Test with complex parameter structures
5. Test error handling and reporting
6. Verify all commands work through this interface

## Documentation
Should include examples of common commands:
- Snapshot operations
- Control operations  
- Component operations
- Status queries
- Future/custom commands