# BUG-055: Complex Type Conversion and Overload Errors

**Status**: Open  
**Severity**: High  
**Priority**: P1 (High)  
**Component**: Type Safety / Tools  
**Reported Date**: 2025-01-21  
**Reporter**: Claude  
**Assignee**: Unassigned  

## Summary
TypeScript has identified 9 complex type errors including invalid type conversions (TS2352), function overload mismatches (TS2769), and missing array properties (TS2740) that require careful type system refactoring.

## Description
These errors represent more complex type system violations that can't be fixed with simple syntax changes:
- Invalid Zod type conversions in base.ts
- Function overload mismatches in controls.ts filter operations
- Missing array properties when assigning objects to array types
- Type narrowing issues with union types

These errors indicate fundamental type modeling issues that need architectural attention.

## Steps to Reproduce
1. Run `npm run type-check`
2. Review TS2352, TS2769, and TS2740 errors
3. Expected result: Proper type conversions and overload matching
4. Actual result: Type system violations requiring refactoring

## Expected Behavior
- Zod types should be properly narrowed before use
- Filter operations should match available overloads
- Array types should be properly distinguished from objects

## Actual Behavior
Complex type errors preventing compilation and indicating design issues.

## Environment
- **OS**: All
- **Node.js Version**: v20.x
- **Project Version/Commit**: bug/001-fix branch
- **TypeScript Version**: 5.x with strict mode

## Error Logs/Stack Trace
```
src/mcp/tools/base.ts(203,20): error TS2352: Conversion of type 'ZodType<TParams>' to type 'ZodObject' may be a mistake
src/mcp/tools/controls.ts(109,50): error TS2769: No overload matches this call.
  Argument of type '(c: QSysControl) => boolean' is not assignable to parameter
src/mcp/tools/status.ts(105,9): error TS2740: Type '{}' is missing the following properties from type 'string[]': length, pop, push, concat
```

## Root Cause Analysis
- **File(s)**: 
  - src/mcp/tools/base.ts (Zod type handling)
  - src/mcp/tools/controls.ts (filter type inference)
  - src/mcp/tools/status.ts (array vs object confusion)
- **Cause**: 
  - Attempting to cast generic Zod types without proper type guards
  - Filter callbacks with incompatible type signatures
  - API responses treated as objects when arrays expected

## Proposed Solution
```typescript
// 1. Fix Zod type handling with proper guards
if (this.paramsSchema instanceof z.ZodObject) {
  const shape = this.paramsSchema.shape;
  // Now safe to use as ZodObject
} else {
  // Handle other Zod types appropriately
}

// 2. Fix filter type issues
const filtered = allControls.filter((c): c is QSysControl => {
  return typeof c.value === 'string' || 
         typeof c.value === 'number' || 
         typeof c.value === 'boolean';
});

// 3. Handle array properties correctly
activeServices: Array.isArray(result.activeServices) 
  ? result.activeServices 
  : [],
```

## Test Cases
- [ ] Test Zod schema introspection
- [ ] Verify filter operations with type predicates
- [ ] Test array/object differentiation
- [ ] Validate edge cases

## Related Issues
- Depends on: Type system understanding from BUG-052
- More complex than: BUG-054 (simple syntax fixes)

## Additional Context
These errors require deeper understanding of TypeScript's type system and may need architectural changes to properly model the domain.

## Acceptance Criteria
- [ ] All complex type errors resolved
- [ ] Proper type guards in place
- [ ] No unsafe type assertions
- [ ] Type system properly models domain

---
**Labels**: bug, type-safety, high-priority, architecture