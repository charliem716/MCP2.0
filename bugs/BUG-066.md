# BUG-066: create_change_group silently overwrites existing groups

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: Change Group Tools  
**Reported Date**: 2025-01-22  
**Reporter**: Code Analysis  
**Assignee**: Unassigned  

## Summary
The create_change_group tool silently overwrites existing groups when the same ID is used, contradicting its description that "Group IDs must be unique".

## Description
The tool description implies that group IDs must be unique, suggesting that attempting to create a group with an existing ID would fail. However, the implementation silently overwrites any existing group with the same ID, potentially losing monitored controls and state without warning.

## Steps to Reproduce
1. Create a change group: `create_change_group({groupId: 'mygroup'})`
2. Add controls: `add_controls_to_change_group({groupId: 'mygroup', controlNames: ['Gain1.gain', 'Gain1.mute']})`
3. Create the same group again: `create_change_group({groupId: 'mygroup'})`
4. Poll the group: `poll_change_group({groupId: 'mygroup'})`
5. Expected result: Error or warning about duplicate group ID
6. Actual result: Original group is overwritten, controls are lost

## Expected Behavior
When attempting to create a group with an existing ID, the tool should either:
1. Return an error indicating the group already exists
2. Return success with a note that the existing group was reused
3. At minimum, warn about overwriting

## Actual Behavior
The implementation at line 686 in adapter.ts creates a new group object without checking if one already exists, silently replacing any existing group and its associated data.

## Environment
- **OS**: All
- **Node.js Version**: All supported versions
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: All

## Error Logs/Stack Trace
No errors - silent data loss occurs.

## Root Cause Analysis
- **File(s)**: src/mcp/qrwc/adapter.ts
- **Line(s)**: 685-690
- **Cause**: No existence check before creating new group object

## Proposed Solution
```typescript
case "ChangeGroup.AddControl": {
  const id = params?.['Id'] as string;
  const controls = params?.['Controls'] as string[] || [];
  
  if (!id) throw new Error("Change group ID required");
  
  let group = this.changeGroups.get(id);
  if (!group) {
    // Only create if doesn't exist
    group = { id, controls: [] };
    this.changeGroups.set(id, group);
    this.changeGroupLastValues.set(id, new Map());
  } else if (controls.length === 0) {
    // This is likely a create_change_group call
    logger.warn(`Change group '${id}' already exists, using existing group`);
  }
  
  // Continue with adding controls...
```

Or update the description to clarify that groups can be reused/overwritten.

## Workaround
Always check if a group exists using list_change_groups before creating.

## Test Cases
- [ ] Test creating a new group
- [ ] Test creating a group with existing ID
- [ ] Test that controls are preserved when appropriate
- [ ] Test error handling for duplicate IDs

## Related Issues
- Related to: Change Group implementation

## Additional Context
- Could lead to unexpected data loss
- Users may lose track of monitored controls
- Description creates false expectation of uniqueness enforcement

## Acceptance Criteria
- [ ] Clear behavior for duplicate group IDs
- [ ] Either enforce uniqueness or update description
- [ ] No silent data loss
- [ ] Tests verify the chosen behavior

## Notes
Need to decide whether to enforce uniqueness (breaking change) or update documentation to reflect actual behavior.

---
**Labels**: bug, change-groups, medium-severity, data-loss  
**Milestone**: Change Group Fixes