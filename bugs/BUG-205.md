# BUG-205: Q-SYS Connection Fails in MCP Mode Despite Core Being Online

## Summary
Change group tools fail with QSYS_CONNECTION_FAILED error in MCP mode, even though the Q-SYS Core is online and reachable. The echo tool works (doesn't check connection), but all Q-SYS tools that check connection state fail.

## Root Cause
When the MCP server starts in production/MCP mode:
1. Logging is completely disabled to avoid stdout pollution (breaks JSON-RPC)
2. Initial Q-SYS connection attempt fails silently (timeout or configuration issue)
3. Server continues running but tools check `isConnected()` and fail
4. Background retry mechanism added but connection still fails in MCP mode

## Investigation Findings

### Direct Connection Test
- Q-SYS Core at 192.168.50.150:443 is reachable (ping works)
- Direct connection using OfficialQRWCClient succeeds in ~1-2 seconds
- Connection state properly synchronized when connected directly

### MCP Mode Behavior
- Echo tool works (no connection check)
- All Q-SYS tools fail with QSYS_CONNECTION_FAILED
- No logs output in MCP mode (by design to prevent stdout pollution)
- Background retry mechanism doesn't establish connection

### Code Analysis
1. **Logger Configuration** (`src/shared/utils/logger.ts:123-126`):
   - In MCP mode, no transports are configured (no logging output)
   - This prevents JSON-RPC stdout pollution but hides errors

2. **MCP Server Start** (`src/mcp/server.ts:329-343`):
   - Attempts Q-SYS connection during startup
   - On failure, logs warning (invisible in MCP mode) and continues
   - Added background retry but connection still fails

3. **Tool Connection Check** (`src/mcp/tools/base.ts:100-108`):
   - All Q-SYS tools check `isConnected()` before executing
   - Fails immediately if not connected

## Attempted Fix
Added background retry mechanism in `src/mcp/server.ts`:
- `scheduleBackgroundConnectionRetry()` method attempts reconnection
- Retries every 5 seconds up to 5 times
- However, connection still fails in MCP mode

## Remaining Issue
The connection works when tested directly but fails when running through the MCP server in production mode. This suggests either:
1. Configuration difference in MCP mode
2. Environment variable or working directory issue
3. Timing issue with MCP server initialization

## Next Steps
The root cause appears to be deeper than just retry logic. Need to investigate:
1. Why initial connection fails in MCP mode but works directly
2. Configuration differences between direct test and MCP mode
3. Possible working directory or path resolution issues

## Test Results
```
Test 11.5.3 Results:
- Echo tool: ✅ Works (no connection check)
- create_change_group: ❌ QSYS_CONNECTION_FAILED
- list_change_groups: ❌ QSYS_CONNECTION_FAILED
- All other change group tools: ❌ QSYS_CONNECTION_FAILED
```

## Files Modified
- `src/mcp/server.ts`: Added background retry mechanism (lines 329-343, 391-431)

## Status
**PARTIALLY FIXED** - Added retry mechanism but connection still fails in MCP mode. Root cause requires further investigation.