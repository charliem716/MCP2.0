# BUG-211: manage_connection validates timeout for all actions

## Summary
The `manage_connection` tool validates the `timeout` parameter globally even for actions that don't use it, causing Test 0.2 to fail.

## Environment
- Q-SYS MCP Server v2.0
- Test Suite: test-prompts-v1.md Test 0.2 (Connection Recovery During Testing)
- Date: 2025-08-17
- Component: src/mcp/tools/connection.ts

## Description
The ManageConnectionSchema defines `timeout` as a top-level optional parameter with validation `.min(1000).max(60000)`. However, this parameter is only used by the `reconnect` action, not by `connect` or other actions.

When Test 0.2 attempts to reconnect with:
```json
{"action":"connect","target":{"host":"192.168.50.150"},"verbose":true,"timeout":30}
```

It fails with:
```
Parameter validation failed
timeout: Number must be greater than or equal to 1000
```

## Root Cause Analysis
The schema validates all parameters globally, regardless of which action is being performed:
- `timeout` is defined at the top level of the schema (line 55)
- Has validation requiring >= 1000ms 
- Is only actually used in `handleReconnect` method (line 436)
- Is NOT used in `handleConnect` method

## Steps to Reproduce
1. Run Test 0.2 which simulates connection loss
2. When prompted for IP, provide "192.168.50.150"
3. Tool calls `manage_connection` with action:"connect" and timeout:30
4. Validation fails even though timeout isn't used for connect action

## Expected vs Actual Behavior

### Expected:
- `timeout` should only be validated for actions that use it (reconnect)
- Or timeout should be ignored for actions that don't use it

### Actual:
- Any `timeout` value < 1000 causes validation failure for ALL actions
- Even actions that don't use timeout fail validation

## Impact
- Test 0.2 fails unnecessarily
- Confusing error messages for users
- API is less forgiving than it should be

## Proposed Fix

### Option 1: Use Discriminated Union (Recommended)
```typescript
const ManageConnectionSchema = z.discriminatedUnion('action', [
  z.object({
    action: z.literal('connect'),
    target: z.object({
      host: z.string(),
      port: z.number().optional(),
    }),
    verbose: z.boolean().optional(),
  }),
  z.object({
    action: z.literal('reconnect'),
    force: z.boolean().optional(),
    maxAttempts: z.number().min(1).max(100).optional(),
    timeout: z.number().min(1000).max(60000).optional(),
  }),
  // ... other actions
]);
```

### Option 2: Conditional Validation
Use `.refine()` to only validate timeout when action is 'reconnect'.

## Workaround
Don't include the `timeout` parameter when calling `manage_connection` with action "connect".

## Status
- **Classification**: RESOLVED
- **Priority**: Medium  
- **Resolution**: Simplified tool from 11 actions to 3 (status/connect/disconnect)
- **Date Resolved**: 2025-08-17

## Resolution Details
Instead of fixing the complex validation, we simplified the entire tool:
- Reduced from 11 actions to just 3 essential ones
- Used discriminated union for clean parameter validation
- Each action now has only the parameters it needs
- Connect action no longer has a timeout parameter
- Tool is now more elegant and easier to use