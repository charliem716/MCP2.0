# BUG-090: Disk Spillover Tests Failing

**Status**: Open  
**Severity**: High  
**Priority**: P1 (High)  
**Component**: Event Cache - Disk Spillover  
**Reported Date**: 2025-01-24  
**Reporter**: Audit System  
**Assignee**: Unassigned  

## Summary
All disk spillover tests in `disk-spillover.test.ts` are failing due to directory creation and file operation issues.

## Description
The disk spillover feature was implemented in Step 2.2 but all associated tests are failing. The tests expect:
- Automatic directory creation for spillover storage
- Events to be written to disk when memory threshold exceeded
- Transparent loading of spilled events during queries
- Cleanup of old spillover files

None of these behaviors are working in the test environment.

## Steps to Reproduce
1. Run `npm test -- --testPathPattern=disk-spillover`
2. Observe all 6 tests fail
3. Check test output for specific failures

## Expected Behavior
- Spillover directory should be created automatically
- Events should spill to disk when memory exceeds threshold
- Queries should transparently load from disk files
- Old spillover files should be cleaned up

## Actual Behavior
- Directory creation fails or returns null stats
- Spillover events are not emitted
- Disk files are not created
- Query results don't include spilled events

## Environment
- **OS**: macOS 14.5
- **Node.js Version**: v20+
- **Project Version/Commit**: cg_event_cache_addon branch

## Error Logs/Stack Trace
```
● EventCacheManager Disk Spillover › Spillover directory creation › should create spillover directory on initialization
    expect(received).toBeTruthy()
    Received: null
      at Object.<anonymous> (src/mcp/state/event-cache/__tests__/disk-spillover.test.ts:83:21)

● EventCacheManager Disk Spillover › Event spillover to disk › should spill events to disk when threshold exceeded
    expect(received).toBe(expected)
    Expected: true
    Received: false
```

## Root Cause Analysis
- **File(s)**: `src/mcp/state/event-cache/manager.ts`
- **Cause**: Possible issues:
  1. Directory permissions in test environment
  2. Async initialization timing issues
  3. Mock file system not properly configured
  4. Path resolution problems in tests

## Proposed Solution
```typescript
// Ensure directory creation is awaited properly
private async initializeDiskSpillover(): Promise<void> {
  if (!this.diskSpilloverConfig?.enabled) return;
  
  try {
    await fs.mkdir(this.diskSpilloverConfig.directory, { recursive: true });
    // Add verification
    const stats = await fs.stat(this.diskSpilloverConfig.directory);
    if (!stats.isDirectory()) {
      throw new Error('Spillover path exists but is not a directory');
    }
  } catch (error) {
    this.logger.error('Failed to initialize disk spillover', { error });
    this.diskSpilloverConfig.enabled = false;
  }
}
```

## Test Cases
- [ ] Fix directory creation in test environment
- [ ] Verify spillover triggers at correct threshold
- [ ] Test file cleanup logic
- [ ] Add error handling tests

## Related Issues
- Related to: Step 2.2 Implementation
- Blocks: Production deployment

## Acceptance Criteria
- [ ] All disk spillover tests pass
- [ ] Directory creation works in all environments
- [ ] File operations are reliable
- [ ] No race conditions in async operations