# BUG-145: GlobalErrorHandler creates logger directly preventing proper test mocking

**Status**: Open  
**Severity**: High  
**Priority**: P1 (High)  
**Component**: shared/utils/errorHandler  
**Reported Date**: 2025-01-31  
**Reporter**: Assistant  
**Assignee**: Unassigned

## Summary

The GlobalErrorHandler class creates its logger instance directly in the constructor, preventing tests from properly mocking the logger and causing test failures with ES module imports.

## Description

The `GlobalErrorHandler` class in `src/shared/utils/errorHandler.ts` directly creates a logger instance using `createLogger('ErrorHandler')` in its constructor. This pattern:

- Prevents tests from injecting mock loggers
- Forces tests to use unreliable `jest.unstable_mockModule` 
- Creates tight coupling between the class and logger implementation
- Makes the singleton export `globalErrorHandler` untestable

## Steps to Reproduce

1. Create a test file for GlobalErrorHandler
2. Try to mock the logger import using `jest.mock()` or `jest.unstable_mockModule`
3. Instantiate GlobalErrorHandler in the test
4. Observe that the real logger is created instead of the mock
5. Tests fail or have to use workarounds

## Expected Behavior

GlobalErrorHandler should accept an optional logger instance through dependency injection, allowing tests to provide mock implementations.

## Actual Behavior

GlobalErrorHandler creates its own logger instance directly, ignoring any test mocks and making the class difficult to test properly.

## Environment

- **OS**: All
- **Node.js Version**: v20+
- **Project Version/Commit**: Current main branch
- **Jest Version**: 29.x with ES modules

## Error Logs/Stack Trace

```typescript
// Current problematic code
constructor(config: ErrorHandlerConfig = {}) {
  this.logger = createLogger('ErrorHandler'); // Direct creation
  // ...
}

// Tests cannot mock this import
import { createLogger } from './logger.js';
```

## Root Cause Analysis

- **File(s)**: src/shared/utils/errorHandler.ts
- **Line(s)**: Line 27
- **Cause**: Direct instantiation of logger in constructor prevents dependency injection

## Proposed Solution

```typescript
// Add logger to config interface
export interface ErrorHandlerConfig {
  logErrors?: boolean;
  enableRecovery?: boolean;
  maxRetryAttempts?: number;
  retryDelay?: number;
  logger?: Logger; // Add optional logger
}

// Update constructor to use injected logger or create default
constructor(config: ErrorHandlerConfig = {}) {
  this.logger = config.logger ?? createLogger('ErrorHandler');
  this.config = {
    logErrors: true,
    enableRecovery: false,
    maxRetryAttempts: 3,
    retryDelay: 1000,
    ...config,
  };
}

// Update singleton to allow DI
export const createGlobalErrorHandler = (config?: ErrorHandlerConfig) => 
  new GlobalErrorHandler(config);

// Keep backward compatibility
export const globalErrorHandler = createGlobalErrorHandler();
```

## Workaround

Currently, tests must use complex ES module mocking or avoid testing logger interactions entirely.

## Test Cases

- [ ] Unit test with mock logger injection
- [ ] Unit test with default logger creation
- [ ] Integration test for error handling with custom logger
- [ ] Verify singleton pattern still works
- [ ] Ensure backward compatibility

## Related Issues

- Related to: BUG-141 (Hanging tests due to module mocking)
- Part of: DI refactoring initiative

## Additional Context

- This is part of a larger effort to refactor all direct logger instantiations to use dependency injection
- Similar pattern successfully applied to `error-recovery.ts`
- Will improve testability across the codebase

## Acceptance Criteria

- [ ] GlobalErrorHandler accepts optional logger in config
- [ ] Tests can inject mock loggers successfully
- [ ] No breaking changes to existing API
- [ ] All existing tests pass
- [ ] New tests demonstrate DI pattern

## Notes

Priority is high because this affects test reliability and is blocking proper test coverage.

---

**Labels**: bug, refactoring, testing, dependency-injection  
**Milestone**: Test Infrastructure Improvement