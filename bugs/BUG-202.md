# BUG-202: set_control_values Validation Mode Fails with "Control not found in Q-SYS response"

## Summary
The `set_control_values` MCP tool fails when `validate:true` is set, returning "Control not found in Q-SYS response" error even for valid controls. The validation works correctly with `validate:false`.

## Status
**FIXED** - 2025-08-11

## Severity
HIGH - Validation is a critical safety feature that should work correctly

## Description
When using the `set_control_values` tool with validation enabled (`validate:true`), the tool incorrectly reports that valid controls are not found. This happens because the validation logic was using the wrong Q-SYS API command for validating named controls.

## Root Cause
The validation logic in `validateNamedControlsBatch()` was using `Control.Get` with a single control name parameter:
```typescript
const response = await this.controlSystem.sendCommand('Control.Get', {
  Name: control.name,
});
```

However, Q-SYS doesn't support this format. The correct approach is to use `Control.GetValues` which accepts an array of control names:
```typescript
const response = await this.controlSystem.sendCommand('Control.GetValues', {
  Names: controlNames,
});
```

## Impact
- Users cannot use validation mode, which is the default behavior
- Forces users to use `validate:false`, losing important safety checks
- Affects all named controls (controls without component prefix)
- Component controls validation worked correctly

## Steps to Reproduce
1. Use `set_control_values` tool with a valid control
2. Set `validate:true` (or omit it, as true is default)
3. Observe error: "Control not found in Q-SYS response"

Example:
```json
{
  "tool": "set_control_values",
  "arguments": {
    "controls": [
      { "name": "Matrix_Mixer 9x6.input.1.gain", "value": -10 }
    ],
    "validate": true
  }
}
```

## Fix Applied
Changed the validation logic to use `Control.GetValues` for batch validation of named controls:

**File**: `src/mcp/tools/controls.ts`
**Method**: `validateNamedControlsBatch()`

The fix:
1. Uses `Control.GetValues` with array of control names
2. Parses the array response to check which controls exist
3. Caches results for improved performance
4. Handles batch validation more efficiently

## Testing
- Unit tests updated and passing
- Manual testing confirms validation now works correctly
- Both component and named controls validated properly
- Error handling improved for invalid controls

## Lessons Learned
1. Always verify Q-SYS API command formats against actual API behavior
2. Test validation modes thoroughly in real environments
3. Unit test mocks must match actual API response formats
4. Batch operations are more efficient than individual validations

## Related Files
- `src/mcp/tools/controls.ts` - Fixed validation logic
- `tests/unit/mcp/tools/set-control-values.test.ts` - Updated test mocks
- `src/mcp/qrwc/command-handlers.ts` - Reference for correct API usage