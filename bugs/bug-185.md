# BUG-185: Event monitoring tools unavailable due to environment configuration

**Status**: Open  
**Severity**: Low  
**Priority**: P3 (Low)  
**Component**: Event Monitoring / MCP Tools  
**Reported Date**: 2025-08-08  
**Reporter**: System Validation  
**Assignee**: Unassigned

## Summary

The `qsys:query_change_events` and `qsys:get_event_statistics` MCP tools are unavailable because event monitoring is not enabled in the environment configuration.

## Description

Both event monitoring tools (query_change_events and get_event_statistics) require the EVENT_MONITORING_ENABLED environment variable to be set to true. When not enabled, these tools return an error indicating the feature is unavailable. This prevents historical event tracking and statistical analysis of control changes.

- What is happening: Tools report "Event monitoring not enabled"
- What should happen: Tools should provide event history and statistics
- Impact: No historical tracking of control changes or event analysis
- Configuration required: EVENT_MONITORING_ENABLED=true

## Steps to Reproduce

1. Start MCP server without EVENT_MONITORING_ENABLED set
2. Call `qsys:query_change_events` tool:
   ```json
   {
     "limit": 10
   }
   ```
3. Expected result: Returns recent change events
4. Actual result: Error "Event monitoring is not enabled in this environment"

## Expected Behavior

When properly configured, the tools should provide:

**query_change_events:**
```json
{
  "events": [
    {
      "timestamp": "2025-08-08T10:30:00Z",
      "componentName": "Main Input Gain",
      "controlName": "gain",
      "oldValue": -10.0,
      "newValue": -5.0,
      "changeType": "value"
    }
  ],
  "totalCount": 150
}
```

**get_event_statistics:**
```json
{
  "totalEvents": 1500,
  "eventsPerMinute": 2.5,
  "topComponents": [
    {"name": "Main Input Gain", "eventCount": 450}
  ],
  "topControls": [
    {"name": "gain", "eventCount": 200}
  ]
}
```

## Actual Behavior

Both tools return:
```json
{
  "error": "Event monitoring is not enabled in this environment"
}
```

## Environment

- **OS**: macOS (from validation report)
- **Node.js Version**: v20.x
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: Designer environment (MCP-Demo-67-Components)
- **MCP Server**: Running with stdio transport
- **Configuration**: EVENT_MONITORING_ENABLED not set

## Error Logs/Stack Trace

```
Warning: Event monitoring requested but not enabled
    at QueryChangeEventsHandler.execute (src/mcp/tools/handlers/query-change-events.ts)
```

## Root Cause Analysis

- **File(s)**: Environment configuration, src/mcp/state/event-monitor/
- **Cause**: The event monitoring system is feature-flagged and requires explicit enablement. This is by design to avoid overhead when historical tracking is not needed.

## Proposed Solution

1. **Documentation Update**: Add clear instructions for enabling event monitoring:
   ```bash
   # In .env file or environment
   EVENT_MONITORING_ENABLED=true
   EVENT_MONITORING_DB_PATH=./data/events  # Optional: specify database location
   ```

2. **Setup Script Enhancement**: Update setup-env.sh to prompt for event monitoring:
   ```bash
   echo "Enable event monitoring for historical tracking? (y/n)"
   read -r enable_monitoring
   if [[ $enable_monitoring == "y" ]]; then
     echo "EVENT_MONITORING_ENABLED=true" >> .env
     echo "EVENT_MONITORING_DB_PATH=./data/events" >> .env
   fi
   ```

3. **Runtime Detection**: Improve error messages to guide users:
   ```typescript
   if (!process.env.EVENT_MONITORING_ENABLED) {
     return {
       error: "Event monitoring is not enabled",
       hint: "Set EVENT_MONITORING_ENABLED=true in your environment to enable this feature",
       documentation: "See docs/event-monitoring.md for configuration details"
     };
   }
   ```

## Workaround

To enable event monitoring:
1. Stop the MCP server
2. Add to `.env` file:
   ```
   EVENT_MONITORING_ENABLED=true
   EVENT_MONITORING_DB_PATH=./data/events
   ```
3. Restart the MCP server
4. Event monitoring tools will now be available

## Test Cases

- [ ] Verify tools work when EVENT_MONITORING_ENABLED=true
- [ ] Verify proper error messages when disabled
- [ ] Test database creation at specified path
- [ ] Test event recording and retrieval
- [ ] Verify statistics calculation accuracy
- [ ] Performance test with high event volume
- [ ] Test database cleanup/rotation

## Related Issues

- Part of: Event monitoring feature set
- Documentation: Needs user guide for event monitoring setup

## Additional Context

- Event monitoring adds overhead (disk I/O, memory for SQLite)
- Should be optional for users who don't need historical tracking
- Database can grow large over time - consider rotation strategy
- According to CLAUDE.md, event monitoring has been restored with SQLite backend

## Acceptance Criteria

- [ ] Clear documentation for enabling event monitoring
- [ ] Setup script prompts for event monitoring configuration
- [ ] Helpful error messages guide users to enable the feature
- [ ] Tools work correctly when properly configured
- [ ] Performance impact is documented
- [ ] Database management strategy documented

## Notes

This is marked as low priority because:
1. The feature is optional and not required for basic functionality
2. It's a configuration issue rather than a code bug
3. Workaround is straightforward

However, the feature is valuable for debugging and analysis, so proper documentation is important.

---

**Labels**: configuration, event-monitoring, mcp-tools, documentation, low-priority  
**Milestone**: Documentation and Configuration