# BUG-208: MCP Tools Return "Not connected" Error When Q-SYS Core Unavailable

## Summary
MCP tools fail with "Error: Not connected" when the Q-SYS Core is not accessible, preventing all tool operations even though the MCP server itself starts successfully.

## Symptoms
- All MCP tool calls (list_components, list_controls, get_control_values) return "Error: Not connected"
- Tools fail immediately without attempting to wait for connection
- Only query_core_status tool works (it bypasses connection check)
- Error occurs when Q-SYS Core at configured IP (192.168.50.150) is not accessible

## Root Cause
The Q-SYS Core **was connected and available** the entire time. The actual issue is a **race condition** during MCP server startup:

1. **MCP Server Startup** (`src/mcp/server.ts:331-343`): 
   - The server starts the MCP stdio transport first
   - Then attempts to connect to Q-SYS Core
   - If connection fails OR takes time, it continues anyway with background retry
   - The `start()` method returns successfully even without Q-SYS connection

2. **Test Timing Issue**: 
   - The test calls MCP tools immediately after server initialization
   - Q-SYS connection takes ~1 second to establish
   - Tools are called before connection completes → "Not connected" error

3. **Connection Check** (`src/mcp/tools/base.ts:101-103` and `src/mcp/qrwc/adapter.ts:309-313`):
   - Tools check `isConnected()` before executing
   - Since Q-SYS isn't connected yet (still connecting), they fail immediately

## Fix Applied

### 1. Added Connection Wait Logic
**`src/mcp/tools/base.ts`**: Tools now wait up to 2 seconds for Q-SYS connection to establish before failing. This prevents race conditions where tools are called immediately after MCP init but before Q-SYS connects.

### 2. Connection Timeout for Initial Startup
**`src/mcp/server.ts`**: Added 5-second timeout for initial connection attempt to prevent indefinite waiting during startup.

### 3. Standardized Error Messages
```typescript
// Before (adapter.ts):
throw new QSysError('QRWC client not connected', QSysErrorCode.CONNECTION_FAILED);

// After:
throw new QSysError('Not connected', QSysErrorCode.CONNECTION_FAILED);
```

```typescript
// Before (base.ts):
throw new QSysError('Q-SYS Core not connected', QSysErrorCode.CONNECTION_FAILED);

// After:
throw new QSysError(
  'Not connected to Q-SYS Core. Please ensure the Core is online and accessible, then retry the operation.',
  QSysErrorCode.CONNECTION_FAILED
);
```

## Testing
Created test scripts to verify error handling:

1. **test-bug-207-simple.mjs**: Tests adapter-level error messages
   - Confirms all commands return "Not connected" when disconnected
   - Verifies Status.Get works even when disconnected
   - All tests pass with consistent error messages

2. **test-bug-207-connection.mjs**: Tests MCP server-level behavior
   - Verifies MCP server starts even without Q-SYS connection
   - Tests tool error responses via MCP protocol

## Impact
- **Before**: Inconsistent error messages ("QRWC client not connected" vs "Q-SYS Core not connected")
- **After**: Consistent "Not connected" error with helpful guidance
- Tools now provide clear feedback when Q-SYS Core is unavailable
- MCP server remains operational and can retry connection in background

## Test Results
```
Testing MCP tool error messages when not connected...
Connection status: Not connected

Testing Component.GetComponents...
  Error: "Not connected"
  ✓ Error message matches expected format

Testing Component.GetControls...  
  Error: "Not connected"
  ✓ Error message matches expected format

Testing Control.Get...
  Error: "Not connected"
  ✓ Error message matches expected format

Testing Status.Get (should work when disconnected)...
  ✓ Status.Get returned disconnected status
```

## Future Improvements
Consider implementing:
1. Connection retry with exponential backoff at tool level
2. Connection status tool to check if Q-SYS is available
3. Queue tool requests during connection establishment
4. Configuration option to require connection before server starts

## Files Modified
- `src/mcp/tools/base.ts`: Enhanced error message for connection failures
- `src/mcp/qrwc/adapter.ts`: Standardized "Not connected" error message

## Status
**RESOLVED** - Race condition fixed. Tools now wait for Q-SYS connection to establish instead of failing immediately. The Q-SYS Core was connected the entire time; the issue was tools being called before the connection completed (~1 second delay).