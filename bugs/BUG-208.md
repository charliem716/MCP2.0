# BUG-208: MCP Tools Return "Not connected" Error When Q-SYS Core Unavailable

## Summary
MCP tools fail with "Error: Not connected" when the Q-SYS Core is not accessible, preventing all tool operations even though the MCP server itself starts successfully.

## Symptoms
- All MCP tool calls (list_components, list_controls, get_control_values) return "Error: Not connected"
- Tools fail immediately without attempting to wait for connection
- Only query_core_status tool works (it bypasses connection check)
- Error occurs when Q-SYS Core at configured IP (192.168.50.150) is not accessible

## Root Cause
The issue occurs at two levels:

1. **Tool Level** (`src/mcp/tools/base.ts:101-103`): BaseQSysTool checks `controlSystem.isConnected()` before executing any tool (unless `skipConnectionCheck()` is overridden)

2. **Adapter Level** (`src/mcp/qrwc/adapter.ts:309-313`): QRWCClientAdapter throws error when `isConnected()` returns false for all commands except Status.Get

When the MCP server starts, it attempts to connect to Q-SYS Core but continues running even if connection fails (with background retry). However, tools immediately fail when called before connection is established.

## Fix Applied

### 1. Standardized Error Messages
Updated error messages for consistency:
- `src/mcp/qrwc/adapter.ts:313`: Changed to `"Not connected"` 
- `src/mcp/tools/base.ts:102-105`: Enhanced message to be more helpful

### 2. Error Message Improvements
```typescript
// Before (adapter.ts):
throw new QSysError('QRWC client not connected', QSysErrorCode.CONNECTION_FAILED);

// After:
throw new QSysError('Not connected', QSysErrorCode.CONNECTION_FAILED);
```

```typescript
// Before (base.ts):
throw new QSysError('Q-SYS Core not connected', QSysErrorCode.CONNECTION_FAILED);

// After:
throw new QSysError(
  'Not connected to Q-SYS Core. Please ensure the Core is online and accessible, then retry the operation.',
  QSysErrorCode.CONNECTION_FAILED
);
```

## Testing
Created test scripts to verify error handling:

1. **test-bug-207-simple.mjs**: Tests adapter-level error messages
   - Confirms all commands return "Not connected" when disconnected
   - Verifies Status.Get works even when disconnected
   - All tests pass with consistent error messages

2. **test-bug-207-connection.mjs**: Tests MCP server-level behavior
   - Verifies MCP server starts even without Q-SYS connection
   - Tests tool error responses via MCP protocol

## Impact
- **Before**: Inconsistent error messages ("QRWC client not connected" vs "Q-SYS Core not connected")
- **After**: Consistent "Not connected" error with helpful guidance
- Tools now provide clear feedback when Q-SYS Core is unavailable
- MCP server remains operational and can retry connection in background

## Test Results
```
Testing MCP tool error messages when not connected...
Connection status: Not connected

Testing Component.GetComponents...
  Error: "Not connected"
  ✓ Error message matches expected format

Testing Component.GetControls...  
  Error: "Not connected"
  ✓ Error message matches expected format

Testing Control.Get...
  Error: "Not connected"
  ✓ Error message matches expected format

Testing Status.Get (should work when disconnected)...
  ✓ Status.Get returned disconnected status
```

## Future Improvements
Consider implementing:
1. Connection retry with exponential backoff at tool level
2. Connection status tool to check if Q-SYS is available
3. Queue tool requests during connection establishment
4. Configuration option to require connection before server starts

## Files Modified
- `src/mcp/tools/base.ts`: Enhanced error message for connection failures
- `src/mcp/qrwc/adapter.ts`: Standardized "Not connected" error message

## Status
**RESOLVED** - Error messages are now consistent and tools handle disconnected state gracefully.