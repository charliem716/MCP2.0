# BUG-208: MCP Tools Return "Not connected" Error Instead of Disconnected Status

## Summary
The `query_core_status` MCP tool was throwing "Error: Not connected" when the MCP server wasn't connected to Q-SYS Core, instead of returning a proper disconnected status response that clients can handle gracefully.

## Symptoms
- `query_core_status` tool threw "Error: Not connected" instead of returning status data
- Test 2.2 from master-test-prompts.md failed with immediate connection error
- Other tools correctly fail with connection errors when not connected
- Clients couldn't distinguish between disconnected state and actual errors

## Root Cause
Two issues were preventing proper disconnected status reporting:

1. **Adapter Connection Check** (`src/mcp/qrwc/adapter.ts:307-314`): 
   - The adapter was checking `isConnected()` and throwing error for all commands
   - Status.Get exemption logic was flawed - the condition wasn't properly exempting it
   - This prevented Status.Get from working when disconnected

2. **Status Tool Logic** (`src/mcp/tools/status.ts:72-73`): 
   - The tool was immediately calling `getStatusFromComponents()`
   - This method tries to execute `Component.GetComponents` which requires connection
   - No check for connection state before attempting component queries

## Fix Applied

### 1. Fixed Adapter Status.Get Exemption (`src/mcp/qrwc/adapter.ts:307-317`)
```typescript
// Before: Flawed exemption logic
if (
  !this.isConnected() &&
  (command as string) !== 'Status.Get' &&
  (command as string) !== 'StatusGet'
) {
  throw new QSysError('Not connected', QSysErrorCode.CONNECTION_FAILED);
}

// After: Clear exemption logic
if (!this.isConnected()) {
  const isStatusCommand = 
    (command as string) === 'Status.Get' || 
    (command as string) === 'StatusGet';
  
  if (!isStatusCommand) {
    throw new QSysError('Not connected', QSysErrorCode.CONNECTION_FAILED);
  }
}
```

### 2. Added Connection Check in Status Tool (`src/mcp/tools/status.ts:72-101`)
```typescript
// Check if connected first
if (!this.controlSystem.isConnected()) {
  // Return disconnected status without trying to query components
  const disconnectedStatus = {
    Platform: 'Q-SYS Designer',
    State: 'Disconnected',
    DesignName: 'Unknown',
    DesignCode: '',
    IsRedundant: false,
    IsEmulator: false,
    Status: {
      Code: 5,
      String: 'Not connected to Q-SYS Core',
    },
    connectionStatus: {
      connected: false,
      message: 'MCP server is not connected to Q-SYS Core'
    }
  };
  
  return {
    content: [{
      type: 'text',
      text: JSON.stringify(disconnectedStatus)
    }],
    isError: false
  };
}
```

## Testing
Created test script `test-bug-208-fix.mjs` to verify the fix:

1. **Starts MCP server without Q-SYS connection**
2. **Tests `query_core_status` returns proper disconnected status**
3. **Verifies other tools fail appropriately with connection errors**

## Test Results
```
Testing BUG-208: MCP Connection Failure
=====================================

Testing query_core_status (should return disconnected status)...

Results:
--------
✅ query_core_status correctly returned disconnected status
   State: Disconnected
   Status.String: Not connected to Q-SYS Core
   Connection: Disconnected

Testing list_components (should fail with connection error)...
✅ list_components correctly failed with: Not connected
```

## Impact
- **Before**: `query_core_status` threw "Error: Not connected" preventing status retrieval
- **After**: Returns proper disconnected status JSON that clients can handle
- Test 2.2 from master-test-prompts.md can now properly handle disconnected state
- MCP clients can distinguish between disconnected state and actual errors

## Files Modified
- `src/mcp/qrwc/adapter.ts`: Fixed Status.Get exemption logic in connection check
- `src/mcp/tools/status.ts`: Added connection check with disconnected status response

## Status
**RESOLVED** - The `query_core_status` tool now properly returns disconnected status information when the MCP server is not connected to Q-SYS Core, instead of throwing an error. This allows clients to handle the disconnected state gracefully.