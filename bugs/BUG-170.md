# BUG-170: Implement Configuration Management and Validation

**Status**: Open  
**Severity**: Low  
**Priority**: P3 (Low)  
**Component**: configuration  
**Reported Date**: 2025-08-07  
**Reporter**: Assistant  
**Assignee**: Unassigned

## Summary

Configuration lacks validation, schema enforcement, and runtime reloading capabilities.

## Description

Current configuration issues:
- No validation on startup
- Missing schema definitions
- No runtime reloading
- Environment variables unchecked
- No configuration profiles
- Hardcoded values scattered

This causes:
- Silent failures from misconfig
- Difficult environment management
- Requires restart for changes
- No config validation

## Steps to Reproduce

1. Provide invalid configuration
2. Start server - runs with bad config
3. Try to reload config at runtime
4. Change environment - manual updates needed
5. Find hardcoded values in code

## Expected Behavior

- Configuration validated on startup
- Schema enforcement
- Runtime reloading supported
- Environment-specific profiles
- Centralized configuration

## Actual Behavior

- No validation
- Invalid config accepted
- Restart required for changes
- Manual environment management
- Scattered configuration

## Environment

- **Configuration Sources**: JSON, environment variables
- **Environments**: Development, staging, production

## Error Logs/Stack Trace

```
// Silent failure from bad config
undefined is not a valid port number
Cannot read property 'host' of undefined
```

## Root Cause Analysis

- No configuration schema
- No validation layer
- Configuration scattered in code
- No central config management

## Proposed Solution

```typescript
// Configuration schema
import { z } from 'zod';

const ConfigSchema = z.object({
  server: z.object({
    port: z.number().min(1).max(65535),
    host: z.string().ip(),
  }),
  qsys: z.object({
    host: z.string().ip(),
    port: z.number().default(443),
    username: z.string().optional(),
    password: z.string().optional(),
    timeout: z.number().default(10000),
  }),
  database: z.object({
    path: z.string(),
    retentionDays: z.number().default(30),
  }),
  monitoring: z.object({
    enabled: z.boolean().default(true),
    bufferSize: z.number().default(1000),
  }),
  logging: z.object({
    level: z.enum(['debug', 'info', 'warn', 'error']),
    format: z.enum(['json', 'text']).default('json'),
  }),
});

// Configuration manager
class ConfigManager {
  private config: Config;
  private watchers = new Set<(config: Config) => void>();
  
  async load(environment: string) {
    // Load base config
    const base = await this.loadFile('config/default.json');
    
    // Load environment specific
    const envConfig = await this.loadFile(`config/${environment}.json`);
    
    // Merge with environment variables
    const merged = this.mergeWithEnv(base, envConfig);
    
    // Validate
    this.config = ConfigSchema.parse(merged);
    
    return this.config;
  }
  
  async reload() {
    const newConfig = await this.load(process.env.NODE_ENV);
    this.config = newConfig;
    
    // Notify watchers
    for (const watcher of this.watchers) {
      watcher(newConfig);
    }
  }
  
  watch(callback: (config: Config) => void) {
    this.watchers.add(callback);
  }
  
  validate() {
    try {
      ConfigSchema.parse(this.config);
      return { valid: true };
    } catch (error) {
      return { valid: false, errors: error.errors };
    }
  }
}

// .env.example
NODE_ENV=production
SERVER_PORT=3000
SERVER_HOST=0.0.0.0
QSYS_HOST=192.168.1.100
QSYS_PORT=443
DATABASE_PATH=/var/lib/mcp/events
LOG_LEVEL=info
```

## Workaround

Manual configuration management

## Test Cases

- [ ] Invalid config rejected on startup
- [ ] Schema validation working
- [ ] Runtime reload successful
- [ ] Environment profiles loading
- [ ] Config changes applied without restart
- [ ] Validation errors meaningful

## Related Issues

- Related to: BUG-166 (Documentation)
- Improves: Deployment experience

## Additional Context

- Improves deployment flexibility
- Reduces configuration errors
- Enables multi-environment support
- Professional configuration management

## Acceptance Criteria

- [ ] Configuration schema defined
- [ ] Validation on startup
- [ ] Runtime reloading implemented
- [ ] Environment profiles supported
- [ ] Central configuration management
- [ ] .env.example complete

## Notes

Nice to have for production flexibility

---

**Labels**: bug, configuration, enhancement  
**Milestone**: Production Readiness