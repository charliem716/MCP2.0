# BUG-203: set_control_values with validate:true fails with "Control not found in Q-SYS response"

## Summary
When using the `set_control_values` MCP tool with `validate:true`, controls that were successfully set were incorrectly reported as failed with the error "Control not found in Q-SYS response". This occurred because Q-SYS often doesn't include successfully set controls in the Component.Set response, only returning controls that had errors or explicit success confirmations.

## Severity
**Medium** - Tool functionality was impaired but had a workaround (using `validate:false`)

## Status
**FIXED** - 2025-08-11

## Impact
- Users couldn't use validation mode (`validate:true`) with `set_control_values`
- All control sets with validation enabled would report false failures
- Forced users to use `validate:false` which skips pre-validation checks

## Root Cause
The `processControlSetResponse` method in `src/mcp/tools/controls.ts` was incorrectly interpreting the absence of a control in the Q-SYS response as a failure. 

Q-SYS Component.Set behavior:
- Only returns controls that explicitly succeeded or failed
- Controls absent from the response are implicitly successful
- This is different from explicit error responses

The code was treating absence as failure when `validate:true`, causing false error reports.

## Reproduction Steps
1. Configure MCP server with valid Q-SYS Core connection
2. Use `set_control_values` tool with `validate:true`:
   ```json
   {
     "controls": [
       { "name": "Matrix_Mixer 9x6.input.1.gain", "value": -6 }
     ],
     "validate": true
   }
   ```
3. Observe error: "Control not found in Q-SYS response"
4. Verify the control was actually set successfully using `get_control_values`

## Fix Applied
Modified the `createControlResponse` method in `src/mcp/tools/controls.ts` (lines 789-800):

**Before:**
```typescript
// When validate:true and control not in response, it failed
if (!validationSkipped && !controlResult) {
  return {
    name: control.name,
    value: control.value,
    success: false,
    error: 'Control not found in Q-SYS response',
  };
}
```

**After:**
```typescript
// When validate:true and control not in response, check if it's actually an error
// Q-SYS Component.Set may not return all controls in the response even when successful
// Only mark as error if we're certain it failed (when Q-SYS explicitly returns an error)
if (!validationSkipped && !controlResult) {
  // For Component.Set, Q-SYS only returns controls that had errors or explicit success
  // Absence from response usually means success (Q-SYS accepted the value)
  return {
    name: control.name,
    value: control.value,
    success: true, // Assume success when Q-SYS doesn't explicitly report an error
  };
}
```

## Testing
Created comprehensive unit tests in `tests/unit/mcp/tools/bug-203-validation-fix.test.ts`:
- ✅ Controls absent from response are marked as successful with `validate:true`
- ✅ Actual Q-SYS errors are still properly reported
- ✅ Mixed success/absent controls handled correctly
- ✅ Named controls (Control.Set) work correctly
- ✅ `validate:false` behavior unchanged

All tests pass successfully.

## Verification
Test Results from master-test-prompts.md Test 11.5.1:
- **Before Fix:** "Control not found in Q-SYS response" error with `validate:true`
- **After Fix:** Controls set successfully with `validate:true`
- Validation still catches legitimate errors (non-existent components/controls)
- Range clamping and type coercion continue to work as expected

## Prevention
- Added comprehensive test coverage for Q-SYS response handling patterns
- Documented Q-SYS Component.Set response behavior in code comments
- Consider adding integration tests with actual Q-SYS Core to catch similar issues

## Related Issues
- None identified

## Files Changed
- `src/mcp/tools/controls.ts` - Fixed response processing logic
- `tests/unit/mcp/tools/bug-203-validation-fix.test.ts` - Added comprehensive test coverage