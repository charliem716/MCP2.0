# BUG-147: Auth coverage boost tests fail due to missing constructor parameters

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: tests/unit/mcp/middleware/auth.coverage-boost.test  
**Reported Date**: 2025-01-31  
**Reporter**: Assistant  
**Assignee**: Unassigned

## Summary

The auth.coverage-boost.test.ts file is failing because it attempts to instantiate MCPAuthenticator without providing the required config and logger parameters.

## Description

The test file `tests/unit/mcp/middleware/auth.coverage-boost.test.ts` has multiple test failures because:

- Tests call `new MCPAuthenticator()` without any parameters
- MCPAuthenticator constructor requires both `config` and `logger` parameters
- The current logger mock setup is not being used properly
- All 16 tests in the file are failing with TypeErrors

## Steps to Reproduce

1. Run `npm test tests/unit/mcp/middleware/auth.coverage-boost.test.ts`
2. Observe all tests fail with TypeError
3. First error: "Cannot read properties of undefined (reading 'enabled')"
4. Subsequent errors: "Cannot read properties of undefined (reading 'info')"

## Expected Behavior

Tests should properly instantiate MCPAuthenticator with required parameters and pass.

## Actual Behavior

All tests fail immediately when trying to create MCPAuthenticator instances without required parameters.

## Environment

- **OS**: All
- **Node.js Version**: v20+
- **Project Version/Commit**: Current main branch
- **Test Framework**: Jest 29.x

## Error Logs/Stack Trace

```
TypeError: Cannot read properties of undefined (reading 'enabled')
  at new MCPAuthenticator (src/mcp/middleware/auth.ts:62:23)
  at Object.<anonymous> (tests/unit/mcp/middleware/auth.coverage-boost.test.ts:31:23)

TypeError: Cannot read properties of undefined (reading 'info')
  at new MCPAuthenticator (src/mcp/middleware/auth.ts:80:19)
  at Object.<anonymous> (tests/unit/mcp/middleware/auth.coverage-boost.test.ts:36:23)
```

## Root Cause Analysis

- **File(s)**: tests/unit/mcp/middleware/auth.coverage-boost.test.ts
- **Line(s)**: Lines 31, 36, 47, 56, 72, 89, etc.
- **Cause**: Tests don't provide required constructor parameters

## Proposed Solution

```typescript
// Create proper mock logger
const mockLogger = {
  info: jest.fn(),
  error: jest.fn(),
  warn: jest.fn(),
  debug: jest.fn(),
  child: jest.fn().mockReturnThis(),
};

// Update all test instantiations
describe('constructor', () => {
  it('should create authenticator with default options', () => {
    const config: AuthConfig = {
      enabled: false,
      apiKeys: [],
    };
    authenticator = new MCPAuthenticator(config, mockLogger);
    expect(authenticator).toBeDefined();
  });

  it('should create authenticator with custom options', () => {
    const config: AuthConfig = {
      enabled: true,
      allowAnonymous: false,
      requireAuth: true,
      jwtSecret: 'test-secret',
      sessionSecret: 'session-secret',
    };
    authenticator = new MCPAuthenticator(config, mockLogger);
    expect(authenticator).toBeDefined();
  });
  
  // Update remaining tests similarly...
});
```

## Workaround

No workaround - tests must be fixed to provide required parameters.

## Test Cases

- [ ] All constructor tests pass with proper parameters
- [ ] Authentication tests work with mock logger
- [ ] Authorization tests function correctly
- [ ] Middleware tests validate behavior
- [ ] Mock logger calls are verified in tests

## Related Issues

- Blocked by: Proper understanding of MCPAuthenticator API
- Related to: General test infrastructure improvements

## Additional Context

- MCPAuthenticator already supports dependency injection (good!)
- Tests just need to be updated to use it properly
- This should improve test coverage once fixed

## Acceptance Criteria

- [ ] All 16 tests in auth.coverage-boost.test.ts pass
- [ ] Tests properly mock and verify logger calls
- [ ] Tests provide appropriate config for each scenario
- [ ] No changes needed to source code (only test fixes)
- [ ] Coverage increases for auth middleware

## Notes

This is a straightforward fix - the source code is already well-designed with DI, the tests just need to use it correctly.

---

**Labels**: bug, testing, test-fix  
**Milestone**: Test Coverage Improvement