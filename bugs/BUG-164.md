# BUG-164: Implement Structured Logging and Monitoring

**Status**: Open  
**Severity**: High  
**Priority**: P1 (High)  
**Component**: logging, monitoring  
**Reported Date**: 2025-08-07  
**Reporter**: Assistant  
**Assignee**: Unassigned

## Summary

Logging lacks structure and monitoring capabilities needed for production debugging and observability.

## Description

Current logging issues:
- No correlation IDs for request tracing
- Missing performance metrics
- No health check endpoint
- Insufficient context in log entries
- No monitoring for critical metrics

Missing monitoring for:
- Event recording rate
- Database size and growth
- Memory usage trends
- Connection status
- API response times

## Steps to Reproduce

1. Try to trace a request through logs
2. Attempt to monitor system health
3. Check performance metrics
4. Debug production issue
5. Observe difficulty in finding related logs

## Expected Behavior

- Correlation IDs link related log entries
- Performance metrics collected
- Health endpoint returns system status
- Structured JSON logs
- Metrics exported for monitoring

## Actual Behavior

- Logs scattered without correlation
- No performance metrics
- No health endpoint
- Text-based logs
- No monitoring capability

## Environment

- **OS**: All
- **Node.js Version**: v20+
- **Project Version/Commit**: Current main branch

## Error Logs/Stack Trace

```
Current logs:
INFO: Connected to Q-SYS
ERROR: Query failed

Need:
{"level":"info","correlationId":"abc-123","component":"qsys","message":"Connected to Q-SYS","timestamp":"2025-01-07T10:00:00Z","metadata":{"host":"192.168.1.1","duration":245}}
```

## Root Cause Analysis

- Winston logger not configured for structured output
- No correlation ID generation
- Missing metrics collection
- No health check implementation
- Performance timing not captured

## Proposed Solution

```typescript
// Correlation ID middleware
app.use((req, res, next) => {
  req.correlationId = generateId();
  logger.setContext({ correlationId: req.correlationId });
  next();
});

// Structured logging
const logger = winston.createLogger({
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  defaultMeta: { service: 'mcp-qsys' }
});

// Health endpoint
app.get('/health', (req, res) => {
  const health = {
    status: 'healthy',
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    connections: {
      qsys: qsysClient.isConnected(),
      database: db.isConnected()
    },
    metrics: {
      eventsPerSecond: eventMonitor.getRate(),
      databaseSize: eventMonitor.getDatabaseSize()
    }
  };
  res.json(health);
});

// Metrics collection
class MetricsCollector {
  private metrics = new Map();
  
  recordMetric(name: string, value: number) {
    this.metrics.set(name, {
      value,
      timestamp: Date.now()
    });
  }
  
  getMetrics() {
    return Object.fromEntries(this.metrics);
  }
}
```

## Workaround

Manual log searching and correlation

## Test Cases

- [ ] Correlation IDs present in all logs
- [ ] Health endpoint returns correct status
- [ ] Metrics collected accurately
- [ ] Performance timing recorded
- [ ] Structured JSON logs output
- [ ] Log aggregation working

## Related Issues

- Related to: BUG-163 (Error Handling)
- Blocks: Production debugging

## Additional Context

- Essential for production debugging
- Required for monitoring/alerting
- Improves incident response time
- Enables performance optimization

## Acceptance Criteria

- [ ] All logs have correlation IDs
- [ ] Health endpoint implemented
- [ ] Metrics collection active
- [ ] Structured JSON logging
- [ ] Performance metrics recorded
- [ ] Monitoring dashboard possible

## Notes

Critical for production observability and debugging

---

**Labels**: bug, logging, monitoring, observability  
**Milestone**: Production Readiness