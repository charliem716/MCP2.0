# BUG-187: Simplify event monitoring by tying recording to change group lifecycle

**Status**: Resolved  
**Severity**: Low  
**Priority**: P3 (Low)  
**Resolution Date**: 2025-08-09  
**Resolution**: Implemented automatic polling when creating change groups  
**Component**: Event Monitoring / MCP Tools / Configuration Management  
**Reported Date**: 2025-08-08  
**Reporter**: System Architecture Review  
**Assignee**: Unassigned

## Summary

Event monitoring initialization requires application restart, and the relationship between event monitoring and change groups is unclear. The system should be simplified so that event monitoring (when enabled) automatically records any change group with AutoPoll, with recording controlled by the change group lifecycle itself.

## Description

The event monitoring system (SQLite-based event tracking) can only be configured via environment variables that are read once at application startup. This creates several operational issues:

- **What is happening**: Event monitoring state is fixed at startup based on `EVENT_MONITORING_ENABLED` environment variable
- **What should happen**: Event monitoring should be controllable at runtime via MCP tools
- **When the issue occurs**: Whenever users need to enable/disable event monitoring without restarting
- **Impact**: 
  - Requires full application restart to change monitoring state
  - Cannot dynamically enable monitoring for debugging production issues
  - Cannot disable monitoring to conserve resources when not needed
  - Poor user experience for configuration management

## Steps to Reproduce

1. Start MCP server without `EVENT_MONITORING_ENABLED` set
2. Attempt to use `qsys:query_change_events` tool
3. Receive error: "Event monitoring is not enabled in this environment"
4. Set `EVENT_MONITORING_ENABLED=true` in environment
5. Must restart entire application for change to take effect
6. Only now can event monitoring tools be used

## Expected Behavior

Users should be able to:
1. Query current event monitoring status via MCP tool
2. Enable event monitoring at runtime via MCP tool
3. Disable event monitoring at runtime via MCP tool
4. Configure event monitoring settings (database path, retention) via MCP tool
5. Changes take effect immediately without restart

Example tool usage:
```json
// Check status
{
  "tool": "qsys:configure_system",
  "action": "get",
  "setting": "event_monitoring"
}

// Enable monitoring
{
  "tool": "qsys:configure_system", 
  "action": "set",
  "setting": "event_monitoring",
  "value": {
    "enabled": true,
    "dbPath": "./data/events",
    "retentionDays": 7
  }
}
```

## Actual Behavior

- Event monitoring state is read once from `process.env.EVENT_MONITORING_ENABLED` at startup
- Cannot be changed without full application restart
- No MCP tool exists to manage configuration
- Tools return static error when monitoring is disabled

## Environment

- **OS**: All platforms
- **Node.js Version**: v20.x
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: All versions
- **MCP Protocol**: Model Context Protocol v1.0

## Error Logs/Stack Trace

```typescript
// Current implementation in src/mcp/tools/event-monitoring/query-events.ts
if (!process.env.EVENT_MONITORING_ENABLED) {
  return {
    error: true,
    message: 'Event monitoring is not enabled in this environment',
    hint: 'Set EVENT_MONITORING_ENABLED=true and restart the application'
  };
}
```

## Root Cause Analysis

- **File(s)**: 
  - `src/config/index.ts` - Static environment variable reading
  - `src/mcp/state/event-monitor/sqlite-event-monitor.ts` - Initialization at startup
  - `src/mcp/tools/event-monitoring/*.ts` - Check environment at runtime
- **Cause**: 
  - Configuration is read once from environment variables at startup
  - No runtime configuration management system exists
  - Event monitor initialization is tied to application startup
  - No mechanism to start/stop event monitoring dynamically

## Proposed Solution

### Simplified Architecture

**Core Principle**: Event monitoring should be transparent and automatic. When enabled via environment variable, it records all change groups that have AutoPoll. No additional configuration or tools needed.

### How It Works

1. **Event Monitoring Enabled (via ENV var)**
   - SQLite database initializes at startup
   - Event monitor attaches to QRWC adapter
   - Ready to record any AutoPoll events

2. **Change Group Lifecycle Controls Recording**
   - **Create change group + Enable AutoPoll** → Starts recording automatically
   - **Disable AutoPoll or Destroy change group** → Stops recording automatically
   - No additional "start/stop recording" commands needed

3. **Simple Mental Model**
   - Event monitoring ON/OFF = Environment variable (requires restart)
   - Recording ON/OFF = Change group with AutoPoll exists or not
   - Users control recording by managing change groups, not by toggling monitoring

### Key Benefits

1. **Simplicity**: No runtime configuration complexity
2. **Predictability**: Clear relationship between change groups and recording
3. **Transparency**: If monitoring is enabled, it just works
4. **Existing Tools**: Uses existing change group management tools

### Implementation Changes

The implementation is actually quite minimal since we're leveraging the existing architecture:

### 1. Update CreateChangeGroupTool to Include Polling Rate

```typescript
// src/mcp/tools/change-groups.ts
const CreateChangeGroupParamsSchema = BaseToolParamsSchema.extend({
  groupId: z.string().describe('Unique identifier for the change group'),
  controls: z.array(z.string()).describe('Array of control names to monitor'),
  pollRate: z.number()
    .min(0.03)
    .max(3600)
    .default(1)
    .describe('Polling rate in seconds (0.03 = 33Hz, 1 = 1Hz). When event monitoring is enabled, this determines recording frequency')
});

export class CreateChangeGroupTool extends BaseQSysTool<CreateChangeGroupParams> {
  protected async executeInternal(params: CreateChangeGroupParams): Promise<ToolCallResult> {
    // Create the change group
    await this.controlSystem.sendCommand('ChangeGroup.Create', {
      Id: params.groupId
    });
    
    // Add controls
    if (params.controls.length > 0) {
      await this.controlSystem.sendCommand('ChangeGroup.AddControl', {
        Id: params.groupId,
        Controls: params.controls.map(name => ({ Name: name }))
      });
    }
    
    // Automatically enable AutoPoll with specified rate
    // This makes the change group immediately start recording if event monitoring is enabled
    await this.controlSystem.sendCommand('ChangeGroup.AutoPoll', {
      Id: params.groupId,
      Rate: params.pollRate
    });
    
    return {
      content: [{
        type: 'text',
        text: JSON.stringify({
          success: true,
          groupId: params.groupId,
          controlCount: params.controls.length,
          pollRate: params.pollRate,
          frequency: `${(1/params.pollRate).toFixed(1)}Hz`,
          recording: process.env.EVENT_MONITORING_ENABLED === 'true' 
            ? 'Recording to database' 
            : 'Polling only (event monitoring disabled)'
        })
      }],
      isError: false
    };
  }
}
```

### 2. Ensure Event Monitor is Initialized at Startup (No Changes Needed)

The existing initialization flow already handles this correctly:
- `MonitoredStateManager` initializes the event monitor if `EVENT_MONITORING_ENABLED=true`
- The monitor attaches to the adapter and listens for `changeGroup:poll` events
- Any change group with AutoPoll will automatically be recorded

### 3. Update Event Monitoring Tools Error Messages

```typescript
// src/mcp/tools/event-monitoring/query-events.ts
protected async executeInternal(params: QueryEventsParams): Promise<ToolCallResult> {
  const eventMonitor = this.stateManager.getEventMonitor();
  
  if (!eventMonitor) {
    return {
      content: [{
        type: 'text',
        text: JSON.stringify({
          error: true,
          message: 'Event monitoring is not enabled',
          hint: 'Set EVENT_MONITORING_ENABLED=true and restart the application. Then create change groups with polling to start recording events.'
        })
      }],
      isError: true
    };
  }
  
  // Continue with normal query logic...
}
```

## Workaround

Current workaround (which becomes the permanent solution):
1. Set environment variable: `export EVENT_MONITORING_ENABLED=true`
2. Optionally set: `export EVENT_MONITORING_DB_PATH=./data/events`
3. Start/restart the MCP server
4. Create change groups with desired polling rate
5. Events are automatically recorded to the database

## Test Cases

- [ ] Test that creating a change group with polling automatically starts recording when monitoring is enabled
- [ ] Test that destroying a change group stops recording its events
- [ ] Test that disabling AutoPoll on a change group stops recording
- [ ] Test that events are NOT recorded when EVENT_MONITORING_ENABLED=false
- [ ] Test that multiple change groups can record simultaneously
- [ ] Test that re-enabling AutoPoll resumes recording
- [ ] Test database file creation in specified path
- [ ] Test that query tools correctly report when monitoring is disabled

## Related Issues

- Related to: BUG-185 (Event monitoring tools unavailable due to environment configuration)
- Enhances: Event monitoring feature set
- Improves: Operational flexibility and debugging capabilities

## Additional Context

### Benefits of Simplified Approach:
- **Simplicity**: No runtime configuration complexity
- **Predictability**: Clear mental model - change groups control recording
- **Transparency**: Event monitoring just works when enabled
- **No New Tools**: Uses existing change group management
- **Performance**: No overhead from configuration management

### Implementation Considerations:
- Minimal code changes required
- Leverages existing event flow
- No thread safety concerns
- No configuration persistence needed
- Clear separation of concerns

### Performance Impact:
- Zero additional overhead
- Same performance as current implementation
- Recording controlled by change group lifecycle

## Acceptance Criteria

- [ ] `create_change_group` tool accepts polling rate parameter
- [ ] Creating a change group with polling automatically enables AutoPoll
- [ ] Event recording starts immediately when change group is created (if monitoring enabled)
- [ ] Event recording stops when change group is destroyed
- [ ] Clear error messages explain the relationship between monitoring and change groups
- [ ] Integration tests cover the simplified flow
- [ ] Documentation updated to explain the transparent recording behavior

## Notes

This simplified approach removes the complexity of runtime configuration while providing a clear, predictable way to control event recording. The key insight is that **change groups already control polling**, so they should also control recording.

The solution makes event monitoring transparent - if it's enabled, it just works. Users don't need to think about "starting" or "stopping" monitoring; they just create and destroy change groups as needed.

Priority is now Low because the simplified approach requires minimal changes and the current behavior (env var + change groups) is actually the desired behavior.

## Resolution

**Resolved on 2025-08-09**

### Changes Implemented:
1. **Updated `CreateChangeGroupTool`** to include `pollRate` parameter and automatically enable AutoPoll
2. **Updated tool descriptions** to clarify that destroying change groups stops recording
3. **Updated error messages** in event monitoring tools to reflect the simplified approach
4. **Verified** that event monitoring initializes correctly from environment variables

### How It Works Now:
- Event monitoring enabled/disabled via `EVENT_MONITORING_ENABLED` environment variable (requires restart)
- Creating a change group with `pollRate` automatically starts polling and recording
- Destroying a change group stops both polling and recording
- No runtime configuration complexity needed

### Test Results:
- ✅ Database file created when monitoring enabled
- ✅ Change groups automatically start polling when created
- ✅ Tools properly report monitoring status
- ✅ Simplified mental model for users

---

**Labels**: enhancement, event-monitoring, mcp-tools, configuration, runtime-management  
**Milestone**: v2.1.0 - Enhanced Configuration Management