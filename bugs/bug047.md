# BUG-047: Create query_qsys_api Tool for Q-SYS API Discovery

## Status: ACTIVE

## Description
AI agents need a way to discover and understand the vast Q-SYS Core API without external documentation. The Q-SYS API includes hundreds of commands across different component types (mixers, gains, routers, snapshots, etc.), each with specific methods and parameter requirements. Currently, agents must guess or rely on limited examples in tool descriptions.

## Problem Statement
- Q-SYS Core has a massive API surface with component-specific methods
- Each component type has different available commands and control methods
- Agents have no way to discover what commands are valid for specific components
- The `send_raw_command` tool requires precise method names and parameters
- No contextual help when commands fail or are used incorrectly

## Affected Components
- New tool needed: `src/mcp/tools/qsys-api.ts`
- Tool registry: `src/mcp/handlers/index.ts`
- Existing documentation: `qrc-reference.md`, `QWRC-Guide.md`

## Current Behavior
Agents must:
1. Guess at Q-SYS method names
2. Trial and error with `send_raw_command`
3. No way to discover component-specific capabilities
4. Limited to examples in tool descriptions

## Expected Behavior
New `query_qsys_api` tool that provides:
1. Method discovery by component type
2. Parameter specifications for each method
3. Examples of proper usage
4. Validation hints and common mistakes
5. Component-aware command suggestions

## Proposed Implementation

### Tool Parameters
```typescript
interface QueryQSysAPIParams {
  // Query type
  query_type: 'methods' | 'components' | 'controls' | 'examples';
  
  // Filters
  component_type?: 'mixer' | 'gain' | 'router' | 'snapshot' | 'delay' | 'eq';
  method_category?: 'Component' | 'Mixer' | 'Control' | 'Snapshot' | 'ChangeGroup';
  search?: string; // Search in method names or descriptions
  
  // Specific queries
  component_name?: string; // Get methods for specific component
  method_name?: string; // Get details for specific method
}
```

### Example Queries and Responses

**Query 1: Get mixer methods**
```json
{
  "query_type": "methods",
  "component_type": "mixer"
}
```
Response:
```json
{
  "component_type": "mixer",
  "methods": [
    {
      "name": "Mixer.SetCrosspointGain",
      "description": "Set gain for mixer crosspoint",
      "params": {
        "Name": "string - Mixer component name",
        "Inputs": "string - Input channel(s), e.g., '1' or '1,2,3'",
        "Outputs": "string - Output channel(s)",
        "Value": "number - Gain in dB (-100 to 20)"
      },
      "example": {
        "method": "Mixer.SetCrosspointGain",
        "params": {"Name": "MainMixer", "Inputs": "1", "Outputs": "1", "Value": -10}
      }
    },
    {
      "name": "Mixer.SetCrosspointMute",
      "description": "Set mute state for mixer crosspoint",
      "params": {
        "Name": "string - Mixer component name",
        "Inputs": "string - Input channel(s)",
        "Outputs": "string - Output channel(s)",
        "Value": "boolean - Mute state (true/false)"
      }
    }
  ]
}
```

**Query 2: Get methods for specific component**
```json
{
  "query_type": "methods",
  "component_name": "MainMixer"
}
```
Response includes component-specific available methods based on actual component type.

**Query 3: Search for snapshot commands**
```json
{
  "query_type": "methods",
  "search": "snapshot"
}
```
Returns all snapshot-related methods with examples.

### Implementation Structure

```typescript
export class QueryQSysAPITool extends BaseQSysTool<QueryQSysAPIParams> {
  private apiReference: QSysAPIReference;
  
  constructor(qrwcClient: any) {
    super(
      qrwcClient,
      "query_qsys_api",
      "Query Q-SYS API reference for available methods, parameters, and examples",
      QueryQSysAPIParamsSchema
    );
    
    // Initialize API reference from documentation
    this.apiReference = new QSysAPIReference();
  }
  
  protected async executeInternal(params: QueryQSysAPIParams): Promise<ToolCallResult> {
    // Route to appropriate query handler
    switch (params.query_type) {
      case 'methods':
        return this.queryMethods(params);
      case 'components':
        return this.queryComponentTypes(params);
      case 'controls':
        return this.queryControlTypes(params);
      case 'examples':
        return this.queryExamples(params);
    }
  }
}
```

### API Reference Data Structure
Build from existing documentation:
1. Parse `qrc-reference.md` for method specifications
2. Extract examples from `qrc-component-control.md`
3. Use TypeScript types from `src/shared/types/qsys.ts`
4. Include real-world usage patterns

## Benefits
1. **Discoverability**: Agents can explore Q-SYS capabilities
2. **Reduced Errors**: Proper parameter specifications prevent mistakes
3. **Learning**: Examples teach correct usage patterns
4. **Context-Aware**: Component-specific method suggestions
5. **Self-Service**: Agents don't need external documentation

## Test Cases
```javascript
// Test 1: Query mixer methods
const result = await tool.execute({
  query_type: 'methods',
  component_type: 'mixer'
});
// Should return all mixer-specific methods

// Test 2: Search for gain-related commands
const result = await tool.execute({
  query_type: 'methods',
  search: 'gain'
});
// Should return Component.Set, Mixer.SetCrosspointGain, etc.

// Test 3: Get examples for specific method
const result = await tool.execute({
  query_type: 'examples',
  method_name: 'Snapshot.Load'
});
// Should return usage examples and common patterns
```

## Implementation Priority
- **High**: This tool directly addresses agent usability with the complex Q-SYS API
- **Effort**: Medium (need to structure existing documentation into queryable format)
- **Impact**: Significant improvement in agent effectiveness

## Related Issues
- Enhances `send_raw_command` tool usability
- Reduces trial-and-error API exploration
- Complements existing discovery tools (`list_components`, `list_controls`)

## Files to Create/Modify
1. Create `src/mcp/tools/qsys-api.ts` - New tool implementation
2. Create `src/mcp/tools/api-reference.ts` - API reference data structure
3. Update `src/mcp/handlers/index.ts` - Register new tool
4. Create `tests/unit/mcp/tools/qsys-api.test.ts` - Unit tests
5. Update `docs/MCP_TOOLS.md` - Document new tool