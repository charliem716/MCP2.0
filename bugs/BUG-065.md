# BUG-065: set_change_group_auto_poll does not stop polling when enabled:false

**Status**: Open  
**Severity**: High  
**Priority**: P1 (High)  
**Component**: Change Group Tools  
**Reported Date**: 2025-01-22  
**Reporter**: Code Analysis  
**Assignee**: Unassigned  

## Summary
The set_change_group_auto_poll tool fails to stop auto-polling when called with enabled:false, contrary to its description.

## Description
The tool description states "Set enabled:false to stop polling", but the implementation does not actually stop the polling timer. Instead, it just returns a success message without taking any action to stop the active timer. This leaves timers running indefinitely, consuming resources and potentially causing unexpected behavior.

## Steps to Reproduce
1. Create a change group: `create_change_group({groupId: 'test'})`
2. Add controls: `add_controls_to_change_group({groupId: 'test', controlNames: ['Gain1.gain']})`
3. Enable auto-poll: `set_change_group_auto_poll({groupId: 'test', enabled: true, intervalSeconds: 1})`
4. Try to disable auto-poll: `set_change_group_auto_poll({groupId: 'test', enabled: false})`
5. Expected result: Auto-polling stops
6. Actual result: Timer continues running, polls keep happening

## Expected Behavior
When enabled:false is passed, the tool should:
1. Find the existing timer for the group
2. Clear the interval timer
3. Remove the timer reference from autoPollTimers map
4. Return success confirmation

## Actual Behavior
The tool returns success but does not stop the timer. The implementation at lines 285-304 in change-groups.ts shows incomplete logic that doesn't actually interact with the timer system.

## Environment
- **OS**: All
- **Node.js Version**: All supported versions
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: All

## Error Logs/Stack Trace
No errors are thrown - the operation silently fails to perform its intended action.

## Root Cause Analysis
- **File(s)**: src/mcp/tools/change-groups.ts
- **Line(s)**: 285-304
- **Cause**: The disable logic is incomplete. It attempts to poll the group but doesn't access or clear the actual timer stored in the adapter.

## Proposed Solution
```typescript
} else {
  // Disable auto polling
  // Need to access the adapter's timer management
  const adapter = this.qrwcClient as any;
  if (adapter.autoPollTimers?.has(params.groupId)) {
    const timer = adapter.autoPollTimers.get(params.groupId);
    clearInterval(timer);
    adapter.autoPollTimers.delete(params.groupId);
  }
  
  return {
    content: [{
      type: 'text',
      text: JSON.stringify({
        success: true,
        groupId: params.groupId,
        autoPollEnabled: false,
        message: `Auto-poll disabled for change group '${params.groupId}'`
      })
    }]
  };
}
```

## Workaround
Destroy and recreate the change group to stop polling, though this loses any state.

## Test Cases
- [ ] Unit test for enabling auto-poll
- [ ] Unit test for disabling auto-poll
- [ ] Integration test verifying timer is cleared
- [ ] Test that multiple enable/disable cycles work correctly

## Related Issues
- Related to: Change Group implementation

## Additional Context
- This is a critical functionality gap that makes the auto-poll feature difficult to manage
- Memory leak potential if users can't stop polling
- The description explicitly promises this functionality

## Acceptance Criteria
- [ ] enabled:false successfully stops the polling timer
- [ ] Timer is removed from autoPollTimers map
- [ ] No more poll events occur after disabling
- [ ] Tool description matches implementation
- [ ] Tests verify the behavior

## Notes
This is a high priority issue because it prevents proper resource management and contradicts the documented behavior.

---
**Labels**: bug, change-groups, high-severity, high-priority  
**Milestone**: Change Group Fixes