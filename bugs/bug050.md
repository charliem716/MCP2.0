# BUG-050: Insufficient reconnection window for Q-SYS Core file loads and reboots

**Status**: Open  
**Severity**: High  
**Priority**: P1 (High)  
**Component**: QRWC Client / Connection Management  
**Reported Date**: 2025-07-20  
**Reporter**: System Analysis  
**Assignee**: Unassigned  

## Summary
The QRWC client's reconnection mechanism stops attempting to reconnect after ~95 seconds, which is insufficient for Q-SYS Core file loads and reboots that typically take 1-2+ minutes. Additionally, the system lacks cache invalidation for component data after long disconnections, risking operations on stale data after design file changes.

## Description
When a Q-SYS Core goes offline for file loading or system reboot, the current reconnection logic attempts to reconnect with exponential backoff (5s → 10s → 20s → 30s → 30s) for a maximum of 5 attempts. This provides only ~95 seconds of reconnection attempts before giving up permanently.

Q-SYS Core reboots commonly take:
- File load: 60-120 seconds (depending on design complexity)
- System reboot: 90-180 seconds
- Firmware update: 3-5 minutes

Critical issue: **When disconnection exceeds 30 seconds, it typically indicates a design file change**, meaning:
- Component names may have changed
- Component types may be different
- Control names and ranges may have been modified
- Entire components may have been added or removed

Currently, the system has no mechanism to invalidate cached component data after long disconnections, which could lead to operations on non-existent or changed components.

After the reconnection attempts are exhausted, the system remains disconnected and requires manual intervention to re-establish the connection.

## Steps to Reproduce
1. Start the MCP server and verify connection to Q-SYS Core
2. In Q-SYS Designer, load a new design file or reboot the Core
3. Monitor the MCP server logs for reconnection attempts
4. Wait for all reconnection attempts to be exhausted (~95 seconds)
5. Observe that the connection is not re-established even after Core comes back online

## Expected Behavior
The system should continue attempting to reconnect until the Q-SYS Core comes back online, with reasonable delays between attempts to avoid excessive network traffic.

## Actual Behavior
After 5 reconnection attempts (~95 seconds), the system stops trying to reconnect and remains permanently disconnected. The logs show:
```
[official-qrwc-client] error: Max reconnection attempts reached
```

## Environment
- **OS**: macOS 14.5
- **Node.js Version**: v22.14.0
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: All versions
- **Configuration**: Default qsys-core.config.json settings

## Error Logs/Stack Trace
```
2025-07-20T22:16:02.798Z [official-qrwc-client] info: Successfully connected to Q-SYS Core
[Core goes offline for file load]
2025-07-20T22:17:15.123Z [official-qrwc-client] debug: State changed {"from":"connected","to":"disconnected"}
2025-07-20T22:17:15.124Z [official-qrwc-client] info: Scheduling reconnection attempt {"attempt":1,"delay":5000}
2025-07-20T22:17:20.125Z [official-qrwc-client] info: Attempting to reconnect {"attempt":1}
2025-07-20T22:17:30.126Z [official-qrwc-client] error: Connection failed: ETIMEDOUT
2025-07-20T22:17:30.127Z [official-qrwc-client] info: Scheduling reconnection attempt {"attempt":2,"delay":10000}
[... continues with attempts 3, 4, 5 ...]
2025-07-20T22:18:45.234Z [official-qrwc-client] error: Max reconnection attempts reached
[No further reconnection attempts even after Core comes back online]
```

## Root Cause Analysis
- **File(s)**: src/qrwc/officialClient.ts
- **Line(s)**: Lines 374-377
- **Cause**: The reconnection logic has a hard limit of `maxReconnectAttempts` (default: 5) after which it stops attempting to reconnect. The exponential backoff with a 5-second base provides insufficient coverage for typical Q-SYS Core downtime periods.

Additional issues:
1. No cache invalidation for component data after long disconnections
2. No event notification to MCP clients about reconnection status
3. No differentiation between temporary (reboot) and permanent (network failure) disconnections
4. Risk of operating on stale component/control data after design file changes

## Proposed Solution
```typescript
// Option 1: Increase default reconnection attempts and interval
// In qsys-core.config.json defaults:
{
  "connectionSettings": {
    "reconnectInterval": 10000,    // 10 seconds base (was 5000)
    "maxReconnectAttempts": 30,    // 30 attempts (was 5)
    "maxReconnectDelay": 60000     // Cap at 60 seconds
  }
}

// Option 2: Implement infinite reconnection with longer delays
// In src/qrwc/officialClient.ts, line 374:
private scheduleReconnect(): void {
  if (this.shutdownInProgress) return;
  
  // Instead of giving up, switch to long-term reconnection
  if (this.reconnectAttempts >= this.options.maxReconnectAttempts) {
    this.logger.warn('Switching to long-term reconnection mode');
    const longTermDelay = 60000; // 1 minute intervals
    
    this.logger.info('Scheduling long-term reconnection attempt', {
      nextAttempt: new Date(Date.now() + longTermDelay).toISOString()
    });
    
    setTimeout(() => this.reconnect(), longTermDelay);
    return;
  }
  
  // ... existing exponential backoff logic
}

// Option 3: Add reconnection event listeners with cache invalidation
// In src/mcp/server.ts:
private disconnectTime: Date | null = null;

private setupReconnectionHandlers(): void {
  this.qrwcClient.on('connected', () => {
    const downtime = this.disconnectTime ? 
      Date.now() - this.disconnectTime.getTime() : 0;
    
    this.logger.info('Q-SYS Core reconnected after downtime', {
      downtimeMs: downtime,
      requiresCacheInvalidation: downtime > 30000
    });
    
    // CRITICAL: Invalidate all cached data if disconnection > 30 seconds
    // This likely means design file changed
    if (downtime > 30000) {
      this.logger.warn('Long disconnection detected - clearing component cache');
      this.invalidateAllCaches();
      this.emit('core_reconnected_design_changed');
    } else {
      this.emit('core_reconnected');
    }
    
    this.disconnectTime = null;
  });
  
  this.qrwcClient.on('disconnected', (reason) => {
    this.disconnectTime = new Date();
    this.logger.warn('Q-SYS Core disconnected', { reason });
    this.emit('core_disconnected', reason);
  });
}

// Option 4: Add cache invalidation to adapter
// In src/mcp/qrwc/adapter.ts:
private invalidateAllCaches(): void {
  // Clear component cache
  this.cachedComponents.clear();
  
  // Clear control index
  this.controlIndex.clear();
  
  // Clear any state in repository
  if (this.stateRepository) {
    this.stateRepository.clearAll();
  }
  
  this.logger.info('All component and control caches invalidated');
}
```

## Workaround
Users can manually increase reconnection attempts in `qsys-core.config.json`:
```json
{
  "qsysCore": {
    "connectionSettings": {
      "reconnectInterval": 10000,
      "maxReconnectAttempts": 30,
      "timeout": 10000
    }
  }
}
```
This provides ~8 minutes of reconnection attempts.

## Test Cases
- [ ] Unit test for reconnection with 2-minute Core downtime
- [ ] Integration test for file load scenario (90 seconds offline)
- [ ] Edge case: Core offline for 5+ minutes (firmware update)
- [ ] Regression test: Verify normal disconnections still handled properly
- [ ] Test cache invalidation after 30+ second disconnection
- [ ] Test MCP tool functionality after reconnection with new design
- [ ] Verify no stale component operations after design change
- [ ] Test differentiation between short (<30s) and long (>30s) disconnections

## Related Issues
- Related to: Connection resilience and reliability
- May affect: All MCP tools that depend on Core connection

## Additional Context
- **Performance impact**: Minimal - reconnection attempts are spaced out
- **Security implications**: None - uses existing authentication
- **Configuration changes needed**: Update default values in config schema
- **Documentation updates required**: Document reconnection behavior and configuration options

This issue is particularly important for production environments where:
- Q-SYS Cores are regularly updated with new design files
- Automatic recovery from maintenance windows is required
- Remote systems need unattended operation

## Acceptance Criteria
- [ ] System successfully reconnects after 2-minute Core downtime
- [ ] Reconnection attempts continue indefinitely with reasonable delays
- [ ] Component cache is invalidated after disconnections > 30 seconds
- [ ] MCP clients are notified of disconnect/reconnect events
- [ ] Different events fired for short vs long disconnections
- [ ] No operations on stale component data after design changes
- [ ] No manual intervention required for reconnection
- [ ] Configuration options documented for different use cases
- [ ] Logs clearly indicate reconnection status, attempts, and cache invalidation

## Notes
Consider implementing a "connection health" MCP tool that reports:
- Current connection status
- Last disconnect time and reason
- Reconnection attempts and next retry time
- Historical uptime statistics
- Cache invalidation events
- Design change detection

This would help operators monitor and troubleshoot connection issues.

**Important Design Consideration**: The 30-second threshold for cache invalidation is based on the observation that:
- Network hiccups and brief disconnections are typically < 10 seconds
- Q-SYS Core restarts without design changes are typically 20-30 seconds
- Design file loads almost always take > 30 seconds
- This threshold provides a safety margin to ensure stale data is cleared

The system should err on the side of caution and invalidate caches when in doubt, as the performance cost of re-discovering components is minimal compared to the risk of operating on non-existent components.

---
**Labels**: bug, qrwc-client, connection-management, high-priority  
**Milestone**: Production Readiness