# BUG-149: QRWC adapter layer files need logger dependency injection

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: mcp/qrwc/*  
**Reported Date**: 2025-01-31  
**Reporter**: Assistant  
**Assignee**: Unassigned

## Summary

Multiple files in the QRWC adapter layer directly create logger instances, preventing proper test mocking and requiring dependency injection refactoring.

## Description

Several QRWC adapter files import and create loggers directly:

- `src/mcp/qrwc/adapter.ts`
- `src/mcp/qrwc/command-handlers.ts`
- `src/mcp/qrwc/validators.ts`
- `src/mcp/qrwc/converters.ts`

These files form the critical adapter layer between MCP and Q-SYS, and their current logger implementation prevents proper unit testing with mock loggers.

## Steps to Reproduce

1. Examine the listed QRWC adapter files
2. Find direct createLogger imports and usage
3. Attempt to write unit tests with logger mocking
4. Observe test failures or need for complex workarounds

## Expected Behavior

All QRWC adapter classes and modules should accept optional logger instances through dependency injection.

## Actual Behavior

QRWC adapter files create their own logger instances directly, making them difficult to test in isolation.

## Environment

- **OS**: All
- **Node.js Version**: v20+
- **Project Version/Commit**: Current main branch
- **Jest Version**: 29.x with ES modules

## Error Logs/Stack Trace

```typescript
// Example patterns found in QRWC files
import { createLogger } from '../../shared/utils/logger.js';

export class QRWCAdapter {
  private logger = createLogger('QRWCAdapter'); // Direct creation
}

// Or in module-level code
const logger = createLogger('command-handlers');
```

## Root Cause Analysis

- **File(s)**: 
  - src/mcp/qrwc/adapter.ts - Main adapter class
  - src/mcp/qrwc/command-handlers.ts - Command processing
  - src/mcp/qrwc/validators.ts - Input validation
  - src/mcp/qrwc/converters.ts - Data conversion
- **Cause**: Direct logger instantiation preventing test isolation

## Proposed Solution

Implement DI pattern for each file:

```typescript
// For adapter.ts
export interface QRWCAdapterOptions {
  logger?: Logger;
  // ... existing options
}

export class QRWCAdapter {
  private logger: Logger;
  
  constructor(options: QRWCAdapterOptions) {
    this.logger = options.logger ?? createLogger('QRWCAdapter');
    // ...
  }
}

// For command-handlers.ts (if using functions)
export interface CommandHandlerContext {
  logger?: Logger;
  // ... other context
}

export function createCommandHandlers(context: CommandHandlerContext = {}) {
  const logger = context.logger ?? createLogger('command-handlers');
  
  return {
    handleCommand: (cmd: Command) => {
      logger.debug('Handling command', { cmd });
      // ...
    }
  };
}

// Similar patterns for validators.ts and converters.ts
```

## Workaround

Currently requires complex ES module mocking or avoiding logger-related test coverage.

## Test Cases

- [ ] Unit tests for adapter with mock logger
- [ ] Unit tests for command handlers with mock logger
- [ ] Unit tests for validators with mock logger
- [ ] Unit tests for converters with mock logger
- [ ] Integration tests with real logger
- [ ] Verify no breaking changes to APIs

## Related Issues

- Related to: BUG-145, BUG-146, BUG-148 (Other DI refactoring)
- Part of: DI refactoring initiative
- Important for: Q-SYS integration testing

## Additional Context

- QRWC adapter layer is critical for Q-SYS communication
- Better testability here improves reliability
- May require different patterns for class-based vs function-based modules

## Acceptance Criteria

- [ ] All four QRWC files support logger DI
- [ ] Tests can inject mock loggers successfully
- [ ] No breaking changes to existing APIs
- [ ] All existing tests pass
- [ ] New unit tests achieve high coverage
- [ ] Logger behavior can be verified in tests

## Notes

The QRWC layer is particularly important for testing as it handles all Q-SYS communication. Improving testability here will help ensure reliable Q-SYS integration.

---

**Labels**: bug, refactoring, testing, dependency-injection, qrwc  
**Milestone**: Test Infrastructure Improvement