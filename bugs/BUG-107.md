# BUG-107: Test Coverage Below Required Thresholds

## Summary
Test suite has regressed from previously fixed state. Multiple test failures have reappeared, and test coverage remains below the required 80% threshold across all metrics.

## Severity
High (upgraded from Medium - significant test regression)

## Current Status (as of 2025-01-27 - Updated after STEP-3.2)
- **Test Suites**: 72 total, 57 passed, 15 failed ❌ (regression from 66/63/3)
- **Individual Tests**: 837 total, 764 passed, 31 skipped, 42 failed ❌ (regression from 771/732/31/8)
- **New Tests Added**: 38 tests for STEP-3.2 (all passing)
- **Coverage**: Below 80% threshold ❌
  - Statements: ~72.35% (target: 80%) - need ~7.65% more
  - Branches: ~64.43% (target: 80%) - need ~15.57% more (biggest gap)
  - Lines: ~74.59% (target: 80%) - need ~5.41% more
  - Functions: ~73.44% (target: 80%) - need ~6.56% more

## Steps to Reproduce
1. Run `npm run test:coverage`
2. Observe coverage report falls below 80% threshold

## Expected Behavior
- All tests should pass ❌ (REGRESSED - was fixed, now failing again)
- Test coverage should be above 80% ❌
- No import/module errors ✅ (FIXED)

## Actual Behavior
- 42 test failures (5% failure rate - regression from 0%)
- 15 test suite failures (21% failure rate)
- Coverage at ~72% (below 80% standard)
- One remaining import.meta usage in src/mcp/index.ts:60 (not causing test failures)
  - Used only for main module detection: `if (import.meta.url === \`file://\${process.argv[1]}\`)`
  - Does not affect test execution

## Root Cause (Updated after STEP-3.2)
Previous fixes have REGRESSED:
1. ~~Jest configuration using deprecated `ts-jest` globals~~ ✅ Still fixed
2. ~~Module system conflicts (ESM vs CommonJS)~~ ✅ Still fixed
3. ~~Import.meta usage in non-ESM context~~ ✅ Still fixed (1 instance remains but not breaking)
4. ~~Mock function expectation failures~~ ❌ REGRESSED - new failures
5. ~~Assertion failures in tool descriptions~~ ❌ REGRESSED - new failures

New test failures from STEP-3.2 work:
1. **MCP Tools Integration Tests** - Component discovery and workflow tests failing
2. **Error Handling Tests** - ValidationError expectations failing
3. **Edge Case Tests** - Tool response format mismatches

Current root causes:
1. **Test expectations outdated** - Mock responses don't match current implementation
2. **Architecture constraints** - Tightly coupled code with external dependencies
3. **Complex mocking requirements** - Files like officialClient.ts need extensive setup
4. **Branch coverage gap** - Many untested conditional paths (~15% gap to target)

## Areas Needing Coverage
Based on coverage report:
1. **src/qrwc/officialClient.ts** - 40.67% coverage (needs significant work)
2. **src/mcp/tools/components.ts** - 60.6% coverage
3. **src/mcp/tools/status.ts** - 71.09% coverage
4. **src/mcp/tools/controls.ts** - 75.61% coverage
5. **src/shared/utils/env.ts** - 43.75% coverage
6. **src/shared/utils/error-recovery.ts** - 34.37% coverage

## Path to 100% Resolution

### Immediate Solution (Recommended)
Temporarily adjust coverage thresholds in `jest.config.ts`:
```javascript
coverageThreshold: {
  global: {
    branches: 70,    // from 80 (current: 66.01%)
    functions: 75,   // from 80 (current: 73.44%)
    lines: 75,       // from 80 (current: 74.59%)
    statements: 75,  // from 80 (current: 73.98%)
  },
},
```

### Long-term Solution (4-5 days)
1. **Refactor for testability** (2-3 days)
   - Extract pure functions from complex classes
   - Add dependency injection patterns
   - Create interfaces for external dependencies
   - Separate WebSocket logic from business logic

2. **Focus on high-impact files** (1-2 days)
   - `officialClient.ts` - Create integration tests instead of unit tests
   - `components.ts` - Test formatResponse and error handling paths
   - `controls.ts` - Cover type determination and edge cases
   - `env.ts` - Test configuration loading scenarios

3. **Quick wins** (4-6 hours)
   - Test error classes' toJSON methods
   - Cover simple getter/setter methods
   - Test default parameter values
   - Add tests for pure utility functions

### Key Challenges Identified
1. **officialClient.ts (40.67%)** - Requires WebSocket and QRWC mocking
2. **Branch coverage deficit (14%)** - Many untested conditional paths
3. **Mock conflicts** - Adding tests to existing files causes failures
4. **Tight coupling** - External dependencies make unit testing difficult

### Recommended Approach
1. Adjust thresholds now to unblock development
2. Create technical debt ticket for coverage improvement
3. Implement refactoring in phases
4. Add integration tests for WebSocket-heavy code
5. Gradually increase thresholds as coverage improves

## Recent Changes (STEP-3.2 Impact)
- Added 38 new tests for config validation (all passing)
- Regression: Test failures increased from 0 to 42
- Regression: Test suite failures increased from 0 to 15
- Coverage slightly decreased due to new code additions
- New TypeScript compilation errors in some environments

## Attempted Solutions (2025-01-26)
1. Created `officialClient.coverage.test.ts` - Failed due to complex WebSocket/QRWC mocking
2. Created `error-recovery.test.ts` - Failed due to module mocking issues
3. Created `env.coverage.test.ts` - Failed due to fs/path mocking conflicts
4. Added tests to existing `controls.test.ts` - Caused test failures due to mock conflicts
5. Added tests to existing `components.test.ts` - Import errors and mock issues

### Why These Failed
- Complex dependency chains require extensive mocking setup
- Test isolation issues when modifying existing test files
- Mocking external libraries (ws, @q-sys/qrwc) is error-prone
- TypeScript strict mode conflicts with test-only property access

## Related Issues
- ~~Blocks verification of STEP-3.1 implementation~~ ✅ No longer blocking
- May block STEP-3.2 acceptance due to test regressions
- Prevents achieving required 80% coverage threshold
- May hide untested edge cases and error conditions
- Related to BUG-123 (MCP tools test failures)

## Estimated Time to Resolution
- **Fix test regressions**: 4-6 hours (update mocks and expectations)
- **With threshold adjustment**: Immediate (but doesn't fix failures)
- **Without refactoring**: 3-4 days (brittle tests)
- **With proper refactoring**: 5-6 days (maintainable tests)

## Recommendations
1. **Immediate**: Fix the 42 failing tests by updating mock expectations
2. **Short-term**: Temporarily lower coverage thresholds to 72%
3. **Long-term**: Refactor for better testability and gradually increase coverage