# BUG-107: Test Coverage Below Required Thresholds

## Summary
Test suite has improved from previous state but still has some failures. Test coverage remains below the required 80% threshold across all metrics.

## Severity
Medium (downgraded from High - significant improvements made)

## Current Status (as of 2025-01-28 - Post STEP-3.2 Merge)
- **Test Suites**: 75 total, 66 passed, 9 failed ✅ (improved from 15 failed)
- **Individual Tests**: 857 total, 809 passed, 31 skipped, 17 failed ✅ (improved from 42 failed)
- **Coverage**: Below 80% threshold ❌
  - Statements: 73.49% (target: 80%) - need 6.51% more
  - Branches: 66.32% (target: 80%) - need 13.68% more (biggest gap)
  - Functions: 73.78% (target: 80%) - need 6.22% more
  - Lines: 74.08% (target: 80%) - need 5.92% more

## Steps to Reproduce
1. Run `npm run test:coverage`
2. Observe coverage report falls below 80% threshold

## Expected Behavior
- All tests should pass ❌ (REGRESSED - was fixed, now failing again)
- Test coverage should be above 80% ❌
- No import/module errors ✅ (FIXED)

## Actual Behavior
- 17 test failures (2% failure rate - improved from 5%)
- 9 test suite failures (12% failure rate - improved from 21%)
- Coverage at ~73.5% (below 80% standard, slight improvement)
- One remaining import.meta usage in src/mcp/index.ts:60 (not causing test failures)
  - Used only for main module detection: `if (import.meta.url === \`file://\${process.argv[1]}\`)`
  - Does not affect test execution

## Root Cause (Updated Post STEP-3.2 Merge)
Previous fixes have mostly held:
1. ~~Jest configuration using deprecated `ts-jest` globals~~ ✅ Still fixed
2. ~~Module system conflicts (ESM vs CommonJS)~~ ✅ Still fixed
3. ~~Import.meta usage in non-ESM context~~ ✅ Still fixed (1 instance remains but not breaking)
4. ~~Mock function expectation failures~~ ⚠️  Some remain but improved
5. ~~Assertion failures in tool descriptions~~ ⚠️  Some remain but improved

Current failing test suites:
1. **Adapter Reliability Tests** - `adapter-reliability.test.ts`
2. **Tools Edge Cases** - `tools-edge-cases.test.ts`
3. **Error Handling Verification** - `error-handling-verification.test.ts`
4. **Server Signal Handlers** - `server-signal-handlers.test.ts`
5. **Adapter Commands** - `adapter-commands.test.ts`
6. **Bug 066 Behavior** - `bug066-behavior.test.ts`
7. **State Synchronizer** - `state-synchronizer.test.ts`
8. **Persistence Manager Integration** - `persistence-manager-integration.test.ts`
9. **Event Cache Error Recovery** - `event-cache-error-recovery.test.ts`

Current root causes:
1. **Test expectations outdated** - Mock responses don't match current implementation
2. **Architecture constraints** - Tightly coupled code with external dependencies
3. **Complex mocking requirements** - Files like officialClient.ts need extensive setup
4. **Branch coverage gap** - Many untested conditional paths (~15% gap to target)

## Areas Needing Coverage
Based on coverage report:
1. **src/qrwc/officialClient.ts** - 40.67% coverage (needs significant work)
2. **src/mcp/tools/components.ts** - 60.6% coverage
3. **src/mcp/tools/status.ts** - 71.09% coverage
4. **src/mcp/tools/controls.ts** - 75.61% coverage
5. **src/shared/utils/env.ts** - 43.75% coverage
6. **src/shared/utils/error-recovery.ts** - 34.37% coverage

## Path to 100% Resolution

### Immediate Solution (Recommended)
Temporarily adjust coverage thresholds in `jest.config.ts`:
```javascript
coverageThreshold: {
  global: {
    branches: 66,    // from 80 (current: 66.32%)
    functions: 73,   // from 80 (current: 73.78%)
    lines: 74,       // from 80 (current: 74.08%)
    statements: 73,  // from 80 (current: 73.49%)
  },
},
```

### Long-term Solution (4-5 days)
1. **Refactor for testability** (2-3 days)
   - Extract pure functions from complex classes
   - Add dependency injection patterns
   - Create interfaces for external dependencies
   - Separate WebSocket logic from business logic

2. **Focus on high-impact files** (1-2 days)
   - `officialClient.ts` - Create integration tests instead of unit tests
   - `components.ts` - Test formatResponse and error handling paths
   - `controls.ts` - Cover type determination and edge cases
   - `env.ts` - Test configuration loading scenarios

3. **Quick wins** (4-6 hours)
   - Test error classes' toJSON methods
   - Cover simple getter/setter methods
   - Test default parameter values
   - Add tests for pure utility functions

### Key Challenges Identified
1. **officialClient.ts (40.67%)** - Requires WebSocket and QRWC mocking
2. **Branch coverage deficit (14%)** - Many untested conditional paths
3. **Mock conflicts** - Adding tests to existing files causes failures
4. **Tight coupling** - External dependencies make unit testing difficult

### Recommended Approach
1. Adjust thresholds now to unblock development
2. Create technical debt ticket for coverage improvement
3. Implement refactoring in phases
4. Add integration tests for WebSocket-heavy code
5. Gradually increase thresholds as coverage improves

## Recent Changes (Post STEP-3.2 Merge)
- STEP-3.2 successfully merged with config validation system
- Test failures reduced from 42 to 17 (60% improvement)
- Test suite failures reduced from 15 to 9 (40% improvement)
- Coverage slightly improved to 73.49% (from ~72%)
- All STEP-3.2 specific tests passing
- BUG-128 fix resolved many test environment issues

## Attempted Solutions (2025-01-26)
1. Created `officialClient.coverage.test.ts` - Failed due to complex WebSocket/QRWC mocking
2. Created `error-recovery.test.ts` - Failed due to module mocking issues
3. Created `env.coverage.test.ts` - Failed due to fs/path mocking conflicts
4. Added tests to existing `controls.test.ts` - Caused test failures due to mock conflicts
5. Added tests to existing `components.test.ts` - Import errors and mock issues

### Why These Failed
- Complex dependency chains require extensive mocking setup
- Test isolation issues when modifying existing test files
- Mocking external libraries (ws, @q-sys/qrwc) is error-prone
- TypeScript strict mode conflicts with test-only property access

## Related Issues
- ~~Blocks verification of STEP-3.1 implementation~~ ✅ No longer blocking
- ~~May block STEP-3.2 acceptance~~ ✅ STEP-3.2 successfully merged
- Prevents achieving required 80% coverage threshold
- May hide untested edge cases and error conditions
- Related to BUG-123 (MCP tools test failures) - partially resolved

## Estimated Time to Resolution
- **Fix remaining 17 test failures**: 2-3 hours (update mocks and expectations)
- **With threshold adjustment**: Immediate (but doesn't fix failures)
- **Without refactoring**: 2-3 days (brittle tests)
- **With proper refactoring**: 4-5 days (maintainable tests)

## Recommendations
1. **Immediate**: Fix the 17 failing tests by updating mock expectations
2. **Short-term**: Temporarily lower coverage thresholds to current levels (73%)
3. **Long-term**: Refactor for better testability and gradually increase coverage

## Progress Summary
- Test failures reduced by 60% (42 → 17)
- Test suite failures reduced by 40% (15 → 9)
- Coverage improved slightly (72% → 73.49%)
- All STEP-3.2 tests passing
- System more stable post-merge