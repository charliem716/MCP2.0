# BUG-067: add_controls_to_change_group returns incorrect control count

**Status**: Open  
**Severity**: Low  
**Priority**: P3 (Low)  
**Component**: Change Group Tools  
**Reported Date**: 2025-01-22  
**Reporter**: Code Analysis  
**Assignee**: Unassigned  

## Summary
The add_controls_to_change_group tool returns the count of all requested controls, not the count of controls actually added, which can be misleading when invalid controls are skipped.

## Description
The tool correctly skips invalid controls as documented, but the return value shows `controlsAdded: params.controlNames.length`, which includes invalid controls that were skipped. This gives users incorrect feedback about how many controls were actually added to the group.

## Steps to Reproduce
1. Create a change group: `create_change_group({groupId: 'test'})`
2. Add mix of valid and invalid controls: 
   ```
   add_controls_to_change_group({
     groupId: 'test', 
     controlNames: ['Gain1.gain', 'InvalidControl.foo', 'Gain1.mute']
   })
   ```
3. Expected result: `controlsAdded: 2` (only valid controls)
4. Actual result: `controlsAdded: 3` (includes invalid control)

## Expected Behavior
The tool should return the actual count of controls that were successfully added to the group, excluding any that were skipped due to being invalid.

## Actual Behavior
The tool returns `params.controlNames.length` at line 81 in change-groups.ts, which is the total number of controls requested, not the number actually added.

## Environment
- **OS**: All
- **Node.js Version**: All supported versions
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: All

## Error Logs/Stack Trace
```
[winston] Control not found: InvalidControl.foo
```

## Root Cause Analysis
- **File(s)**: src/mcp/tools/change-groups.ts, src/mcp/qrwc/adapter.ts
- **Line(s)**: change-groups.ts:81, adapter.ts:698-706
- **Cause**: The adapter logs warnings for invalid controls but doesn't return information about which controls were actually added

## Proposed Solution
Option 1: Have the adapter return the actual count of added controls:
```typescript
// In adapter.ts
let addedCount = 0;
for (const control of controls) {
  if (!this.controlIndex.has(control)) {
    logger.warn(`Control not found: ${control}`);
    continue;
  }
  if (!group.controls.includes(control)) {
    group.controls.push(control);
    addedCount++;
  }
}
return { result: { added: addedCount } };

// In change-groups.ts
const result = await this.qrwcClient.sendCommand("ChangeGroup.AddControl", {
  Id: params.groupId,
  Controls: params.controlNames
});

const addedCount = (result as any)?.result?.added || params.controlNames.length;
```

Option 2: Return detailed information about which controls were added/skipped.

## Workaround
Use list_change_groups or poll_change_group after adding to see actual controls in the group.

## Test Cases
- [ ] Test adding all valid controls
- [ ] Test adding all invalid controls
- [ ] Test adding mix of valid and invalid controls
- [ ] Test return value accuracy

## Related Issues
- Related to: Change Group implementation

## Additional Context
- Low severity as it doesn't affect functionality
- Could cause confusion in logging/debugging
- Users might think all controls were added when some were skipped

## Acceptance Criteria
- [ ] Return value accurately reflects controls actually added
- [ ] Invalid controls are still skipped as documented
- [ ] Clear feedback about what was added vs skipped
- [ ] Tests verify accurate counting

## Notes
Consider whether to return more detailed information (which controls succeeded/failed) rather than just a count.

---
**Labels**: bug, change-groups, low-severity, ux  
**Milestone**: Change Group Fixes