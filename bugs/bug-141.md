# BUG-141: Test Coverage Below 80% Threshold - Branch Coverage Critical

**Status**: Open  
**Severity**: High  
**Priority**: P1 (High)  
**Component**: Testing, Code Coverage  
**Reported Date**: 2025-07-30  
**Reporter**: System Analysis  
**Assignee**: Unassigned

## Summary

Test coverage is below the required 80% threshold across all metrics, with branch coverage having the most critical gap at 59.57% (20.43% below target).

## Description

After the BUG-132 refactoring and exclusion of archived-complex code, the actual test coverage is:
- **Statements**: 67.69% (need +12.31%)
- **Branches**: 59.57% (need +20.43%) ⚠️ CRITICAL
- **Functions**: 67.69% (need +12.31%)
- **Lines**: 67.98% (need +12.02%)

The branch coverage gap indicates many conditional paths (if/else statements, ternary operators, switch cases) are untested, creating risk for edge case bugs.

## Steps to Reproduce

1. Run `npm run test:coverage`
2. Open `coverage/index.html` in a browser
3. Observe coverage percentages below 80% threshold
4. Note Jest configuration expects 80% minimum coverage

## Expected Behavior

- All coverage metrics should be ≥ 80%
- Branch coverage should test both true and false paths of conditionals
- CI/CD pipeline should pass coverage checks

## Actual Behavior

Coverage fails to meet thresholds:
- Overall coverage ~67.7%
- Branch coverage critically low at 59.57%
- Several core files have <50% coverage

## Environment

- **Test Framework**: Jest v29
- **Coverage Tool**: Istanbul/nyc
- **Coverage Threshold**: 80% (configured in jest.config.ts)

## Error Logs/Stack Trace

Files with critically low coverage:
```
src/qrwc/officialClient.ts            40.67%
src/shared/utils/error-recovery.ts    34.37%
src/shared/utils/env.ts               43.75%
src/mcp/tools/components.ts           60.60%
src/mcp/tools/status.ts               71.09%
```

## Root Cause Analysis

- **Primary Cause**: Many error handling paths and edge cases lack tests
- **Branch Coverage Gap**: Conditional logic extensively used but not fully tested
- **Historical Debt**: Some files were written without corresponding tests
- **Refactoring Impact**: BUG-132 refactoring exposed previously hidden coverage gaps

## Proposed Solution

1. **Immediate Priority - Branch Coverage** (1-2 days):
```typescript
// Focus on untested conditionals
// Example: error-recovery.ts
it('should handle both success and failure paths', () => {
  // Test when condition is true
  expect(recoverFromError(validError)).toResolve();
  
  // Test when condition is false  
  expect(recoverFromError(unrecoverableError)).toReject();
});
```

2. **High-Impact Files** (1 day):
```typescript
// Add integration tests for officialClient.ts
describe('OfficialQRWCClient WebSocket handling', () => {
  // Mock WebSocket behaviors
  // Test connection, disconnection, reconnection
  // Test error scenarios
});
```

3. **Quick Wins** (4-6 hours):
- Test error class `.toJSON()` methods
- Cover default parameter values
- Test type guard functions
- Add tests for pure utility functions

## Workaround

Temporary: Lower coverage thresholds in jest.config.ts (NOT RECOMMENDED):
```typescript
coverageThreshold: {
  global: {
    branches: 60,
    functions: 68,
    lines: 68,
    statements: 68,
  },
},
```

## Test Cases

Priority areas for new tests:
- [ ] Error handling paths in officialClient.ts
- [ ] All branches in error-recovery.ts utility functions
- [ ] Environment variable loading edge cases in env.ts
- [ ] Component filtering logic in components.ts
- [ ] Status formatting conditions in status.ts
- [ ] Null/undefined handling across all files
- [ ] Timeout and retry logic branches
- [ ] Type determination conditionals

## Related Issues

- Parent issue: BUG-107
- Caused by: BUG-132 (refactoring exposed gaps)
- Related to: BUG-095 (coverage measurement setup)

## Additional Context

**Why Branch Coverage Matters Most**:
- Untested branches often hide critical bugs
- Error paths are rarely executed in normal operation
- Edge cases cause production incidents
- 20.43% gap represents hundreds of untested decision points

**Recommended Tools**:
- Use coverage HTML report to identify untested lines
- Focus on red (uncovered) and yellow (partially covered) sections
- Consider mutation testing to verify test quality

## Acceptance Criteria

- [ ] Statement coverage ≥ 80%
- [ ] Branch coverage ≥ 80% (critical)
- [ ] Function coverage ≥ 80%
- [ ] Line coverage ≥ 80%
- [ ] All high-risk files have >70% coverage
- [ ] No decrease in existing coverage
- [ ] New tests are maintainable and clear

## Notes

This is blocking deployment to production environments. Focus on branch coverage first as it has the largest gap and highest risk. Consider pair programming or mob testing sessions to quickly increase coverage.

---

**Labels**: bug, testing, coverage, high-priority, technical-debt  
**Milestone**: Production Readiness