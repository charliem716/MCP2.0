# BUG-184: clear_change_group not implemented in QRWC adapter

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: QRWC Adapter / Change Group Management  
**Reported Date**: 2025-08-08  
**Reporter**: System Validation  
**Assignee**: Unassigned

## Summary

The `qsys:clear_change_group` MCP tool fails with "Unknown QRWC command: ChangeGroup.Clear" error, preventing clearing all controls from a change group while preserving the group itself.

## Description

The clear_change_group tool should allow users to remove all controls from an existing change group without destroying the group structure. This is useful for resetting monitoring configurations or preparing a group for a completely different set of controls. Currently, users must destroy and recreate the group to achieve this.

- What is happening: Tool throws "Unknown QRWC command" error
- What should happen: Tool should clear all controls from the group
- Impact: Cannot efficiently reset change groups for reuse
- Error message: "Unknown QRWC command: ChangeGroup.Clear"

## Steps to Reproduce

1. Connect to Q-SYS Core using MCP server
2. Create a change group and add multiple controls to it
3. Call `qsys:clear_change_group` tool:
   ```json
   {
     "groupId": "group_123"
   }
   ```
4. Expected result: All controls removed from group, group remains active
5. Actual result: Error "Unknown QRWC command: ChangeGroup.Clear"

## Expected Behavior

The tool should clear all controls and return confirmation:
```json
{
  "success": true,
  "message": "Cleared all controls from change group 'group_123'",
  "previousControlCount": 10
}
```

## Actual Behavior

Tool returns an error:
```json
{
  "error": "Unknown QRWC command: ChangeGroup.Clear"
}
```

## Environment

- **OS**: macOS (from validation report)
- **Node.js Version**: v20.x
- **Project Version/Commit**: Current main branch
- **Q-SYS Core Version**: Designer environment (MCP-Demo-67-Components)
- **MCP Server**: Running with stdio transport

## Error Logs/Stack Trace

```
Error: Unknown QRWC command: ChangeGroup.Clear
    at QRWCAdapter.executeCommand (src/qrwc/qrwcAdapter.ts)
    at ClearChangeGroupHandler.execute (src/mcp/tools/handlers/clear-change-group.ts)
```

## Root Cause Analysis

- **File(s)**: src/qrwc/qrwcAdapter.ts
- **Line(s)**: executeCommand method switch statement
- **Cause**: The QRWC adapter does not implement the 'ChangeGroup.Clear' command. This is part of the advanced change group management functionality that is currently missing.

## Proposed Solution

Implement the `ChangeGroup.Clear` command in the QRWC adapter:

```typescript
// In qrwcAdapter.ts executeCommand method
case 'ChangeGroup.Clear':
  const groupId = params.Id as string;
  
  const changeGroup = this.changeGroups.get(groupId);
  if (!changeGroup) {
    throw new Error(`Change group ${groupId} not found`);
  }
  
  const groupInfo = this.changeGroupInfo.get(groupId);
  const previousCount = groupInfo?.controls.length || 0;
  
  // Clear all controls from the SDK's change group
  if (groupInfo) {
    for (const controlName of groupInfo.controls) {
      await changeGroup.removeControl(controlName);
    }
    groupInfo.controls = [];
  }
  
  // Disable auto-poll if it was enabled
  if (groupInfo?.autoPollInterval) {
    clearInterval(groupInfo.autoPollInterval);
    groupInfo.autoPollInterval = null;
  }
  
  return {
    Success: true,
    PreviousControlCount: previousCount
  };
```

## Workaround

To clear all controls from a change group:
1. Get the group ID
2. Call `destroy_change_group` to remove the group
3. Call `create_change_group` to create a new group with the same ID (if ID preservation is needed)

This workaround loses any group-specific configuration and may cause monitoring interruptions.

## Test Cases

- [ ] Unit test for ChangeGroup.Clear command in adapter
- [ ] Integration test clearing group with multiple controls
- [ ] Integration test clearing already empty group
- [ ] Edge case: Clear non-existent group
- [ ] Verify auto-poll is properly disabled after clear
- [ ] Verify group can accept new controls after clear
- [ ] Regression test: Other change group operations still work

## Related Issues

- Related to: BUG-183 (remove_controls_from_change_group implementation)
- Part of: Change group management feature set

## Additional Context

- This feature improves change group reusability
- Important for scenarios where monitoring requirements change frequently
- Should properly handle auto-poll state (disable when cleared)
- Consider whether to preserve other group settings or reset everything

## Acceptance Criteria

- [ ] clear_change_group successfully removes all controls
- [ ] Change group remains active and can accept new controls
- [ ] Auto-poll is properly disabled if it was enabled
- [ ] Proper error handling for non-existent groups
- [ ] Performance is acceptable (<200ms for typical requests)
- [ ] All test cases pass
- [ ] Documentation updated with usage examples

## Notes

This feature, along with BUG-183, completes the change group management feature set. While not critical, it significantly improves the developer experience when working with dynamic monitoring scenarios.

---

**Labels**: bug, qrwc-adapter, change-groups, medium-priority  
**Milestone**: Enhanced Change Group Management