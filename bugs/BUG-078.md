# BUG-078: Event Cache missing event type detection for intelligent filtering

**Status**: Open  
**Severity**: Low  
**Priority**: P3 (Low)  
**Component**: State Management / Event Cache  
**Reported Date**: 2025-07-23  
**Reporter**: System Analysis  
**Assignee**: Unassigned  

## Summary
The Event Cache does not detect or classify event types (change/threshold/transition), limiting the ability to filter events by their significance or behavior pattern.

## Description
The Phase 1.2 checklist specified "Detect event types (change/threshold/transition)" but this was not implemented. Event type detection would enable:
- Filtering for only threshold crossings (e.g., level exceeded -6dB)
- Finding state transitions (e.g., mute falseâ†’true)
- Identifying significant changes vs. noise
- Reducing query results to meaningful events
- Building smarter alerting rules

Without event types, all value changes are treated equally, making it harder to find significant events in high-frequency streams.

## Steps to Reproduce
1. Add events showing a level control crossing -6dB threshold
2. Add events showing a mute control changing from false to true
3. Add events showing small fluctuations in a meter reading
4. Query the events
5. Observe all events are returned with no type classification
6. Cannot filter for "threshold crossed" or "state transition" events

## Expected Behavior
Events should be classified as:
- `change`: Any value change (default)
- `threshold_crossed`: Numeric value crossed a defined threshold
- `state_transition`: Boolean or enum value changed state
- `significant_change`: Numeric value changed by more than X%

Event type should be:
- Calculated during event storage
- Available in query results
- Filterable in queries

## Actual Behavior
- All events are stored without type classification
- No way to determine event significance
- Must manually analyze values to find transitions
- No built-in threshold detection

## Environment
- **OS**: All
- **Node.js Version**: v20.11.0+
- **Project Version/Commit**: Current main branch

## Error Logs/Stack Trace
N/A - Missing functionality

## Root Cause Analysis
- **File(s)**: src/mcp/state/event-cache/manager.ts
- **Line(s)**: 140-152 (handleChangeEvent method)
- **Cause**: Event type detection was not implemented in initial version

## Proposed Solution
```typescript
// Add to CachedEvent interface
export interface CachedEvent {
  // ... existing fields ...
  eventType?: 'change' | 'threshold_crossed' | 'state_transition' | 'significant_change';
  threshold?: number; // Which threshold was crossed
  significance?: number; // Percentage change for numeric values
}

// Add configuration for thresholds
export interface EventCacheConfig {
  // ... existing fields ...
  thresholds?: {
    [controlPattern: string]: number[]; // e.g., "*.level": [-6, 0, 6]
  };
  significantChangePercent?: number; // Default: 5%
}

// Update handleChangeEvent to detect types
private handleChangeEvent(event: any): void {
  // ... existing code ...
  
  for (const change of changes) {
    const previousValue = groupLastValues.get(change.Name);
    const eventType = this.detectEventType(
      change.Name,
      previousValue,
      change.Value
    );
    
    const cachedEvent: CachedEvent = {
      // ... existing fields ...
      eventType,
      threshold: eventType === 'threshold_crossed' 
        ? this.findCrossedThreshold(change.Name, previousValue, change.Value)
        : undefined,
      significance: eventType === 'significant_change'
        ? this.calculateSignificance(previousValue, change.Value)
        : undefined
    };
    
    // ... rest of method
  }
}

private detectEventType(
  controlName: string, 
  previousValue: unknown, 
  currentValue: unknown
): CachedEvent['eventType'] {
  // No previous value = first event
  if (previousValue === undefined) {
    return 'change';
  }
  
  // State transition for boolean/string values
  if (typeof currentValue === 'boolean' || typeof currentValue === 'string') {
    if (previousValue !== currentValue) {
      return 'state_transition';
    }
  }
  
  // Numeric analysis
  if (typeof previousValue === 'number' && typeof currentValue === 'number') {
    // Check threshold crossings
    const threshold = this.findCrossedThreshold(controlName, previousValue, currentValue);
    if (threshold !== undefined) {
      return 'threshold_crossed';
    }
    
    // Check significant change
    const changePercent = Math.abs((currentValue - previousValue) / previousValue) * 100;
    if (changePercent >= (this.defaultConfig.significantChangePercent || 5)) {
      return 'significant_change';
    }
  }
  
  return 'change';
}

private findCrossedThreshold(
  controlName: string,
  previousValue: unknown,
  currentValue: unknown
): number | undefined {
  if (typeof previousValue !== 'number' || typeof currentValue !== 'number') {
    return undefined;
  }
  
  // Find matching threshold configuration
  const thresholds = this.getThresholdsForControl(controlName);
  if (!thresholds.length) return undefined;
  
  // Check each threshold
  for (const threshold of thresholds) {
    const crossedUp = previousValue < threshold && currentValue >= threshold;
    const crossedDown = previousValue > threshold && currentValue <= threshold;
    
    if (crossedUp || crossedDown) {
      return threshold;
    }
  }
  
  return undefined;
}

// Add to EventQuery for filtering
export interface EventQuery {
  // ... existing fields ...
  eventTypes?: Array<'change' | 'threshold_crossed' | 'state_transition' | 'significant_change'>;
}
```

## Workaround
Manually analyze previousValue and value in query results to determine event significance.

## Test Cases
- [ ] Unit test: Boolean state transitions detected correctly
- [ ] Unit test: Threshold crossings detected (up and down)
- [ ] Unit test: Significant numeric changes detected
- [ ] Unit test: Small changes marked as regular 'change'
- [ ] Unit test: Event type filtering in queries
- [ ] Integration test: Threshold configuration patterns

## Related Issues
- Related to: BUG-072 (Event Cache implementation)
- Enhancement to: Phase 1.2 requirements

## Additional Context
- Useful for reducing noise in high-frequency data
- Enables smarter alerting and monitoring
- Could be extended with custom event type detection
- Performance impact should be minimal

## Acceptance Criteria
- [ ] Events are classified by type during storage
- [ ] Event types can be filtered in queries
- [ ] Threshold detection works for configured controls
- [ ] Significant change detection uses configurable percentage
- [ ] Documentation explains event type detection
- [ ] Performance impact is negligible

## Notes
While this is a "nice to have" feature, it significantly improves the usability of the Event Cache for monitoring and alerting scenarios. The implementation is straightforward and adds meaningful value.

---
**Labels**: bug, event-cache, enhancement, low-priority  
**Milestone**: Event Cache v2