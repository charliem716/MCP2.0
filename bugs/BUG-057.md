# BUG-057: Enhance query_core_status to Return Real Status Component Data

**Status**: Open  
**Severity**: Medium  
**Priority**: P1 (High)  
**Component**: MCP Tools / Status  
**Reported Date**: 2025-07-21  
**Reporter**: User Request  
**Assignee**: Unassigned  
**Bug Type**: Enhancement  

## Summary
The `query_core_status` tool currently returns static/fallback data when the Q-SYS Core doesn't support the `StatusGet` command. This enhancement will make the tool return actual status data by reading control values from status-type components in the Q-SYS design.

## Description
Currently, when `StatusGet` command fails (which is common), the tool returns generic fallback data that provides limited value. However, Q-SYS designs typically contain dedicated "Status" components that monitor system health, device status, and performance metrics.

This enhancement will:
1. Identify status-related components in the design
2. Read their control values
3. Return organized, meaningful status data
4. Provide real system health information instead of static fallbacks

## Current Behavior
When `StatusGet` fails, returns:
```json
{
  "Platform": "Q-SYS Core (API: StatusGet not supported)",
  "State": "Active",
  "DesignName": "Design with 43 components",
  "Status": {
    "Code": 0,
    "String": "OK"
  },
  "IsConnected": true
}
```

## Expected Behavior
Return actual status data from status components:
```json
{
  "CoreStatus": {
    "CPU_Usage": { "value": 15, "unit": "%", "status": "normal" },
    "Temperature": { "value": 45, "unit": "Â°C", "status": "normal" },
    "Uptime": { "value": "5 days 3:24:15", "status": "healthy" }
  },
  "PeripheralStatus": {
    "Touchpanel": {
      "Connected": true,
      "IP": "192.168.1.101",
      "LastSeen": "2 seconds ago"
    },
    "TableMic": {
      "Connected": true,
      "BatteryLevel": 85,
      "SignalStrength": "Excellent"
    }
  },
  "NetworkStatus": {
    "Primary": "Connected",
    "Redundant": "Not configured"
  }
}
```

Or if no status components found:
```json
{
  "message": "No status components detected",
  "componentCount": 43,
  "suggestion": "Status components typically have 'Status' in their name"
}
```

## Implementation Details

### Status Component Detection (Hybrid Approach)
Use multiple methods to identify status components:

1. **Name Pattern Matching**
   - Components containing: `status`, `monitor`, `health`, `diagnostic`
   - Components ending with: `_state`, `_status`
   - Components starting with: `sys_`, `system_`

2. **Component Type Matching**
   - Known types: `Status Combiner`, `System Monitor`, `Device Monitor`, `Core Status`

3. **Control Analysis**
   - All controls are read-only (Direction = "Read")
   - Has status-related control names: `status`, `health`, `online`, `connected`, `fault`, `error`, `cpu`, `memory`, `temp`

4. **Scoring System**
   ```javascript
   function getStatusScore(component) {
     let score = 0;
     if (nameMatchesPattern) score += 3;
     if (allControlsReadOnly) score += 2;
     if (hasStatusControls) score += controlCount; // max 3
     if (isKnownStatusType) score += 5;
     if (hasAudioControls) score -= 5; // negative indicator
     return score;
   }
   // Include if score >= 3
   ```

### Response Organization
- Group by category if possible (Core, Peripherals, Network, etc.)
- Flat structure is acceptable if categorization is complex
- Include control metadata (units, normal ranges if detectable)

### Examples from Real Q-SYS Design
From the test system, these components would be detected:
- `Status_Table Mic`
- `Status_Soundbar`
- `Status_NV-21-HU-1`
- `Status Microsoft Teams Room Compute`
- `Status_Touchpanel`
- `Status_NV32_Core`

## Root Cause Analysis
- **File(s)**: `src/mcp/qrwc/adapter.ts`, `src/mcp/tools/status.ts`
- **Cause**: Original implementation assumed `StatusGet` command would be universally supported
- **Impact**: Tool provides limited value when StatusGet isn't supported (common scenario)

## Proposed Solution
1. Modify `query_core_status` tool to attempt `StatusGet` first
2. On failure, scan for status components using hybrid detection
3. Retrieve control values for all detected status components
4. Organize and return meaningful status data
5. Return "no status components detected" if none found

## Test Cases
- [ ] Tool attempts StatusGet command first
- [ ] On StatusGet failure, falls back to component scanning
- [ ] Correctly identifies status components using all detection methods
- [ ] Retrieves control values for status components
- [ ] Groups status data by category when possible
- [ ] Returns proper message when no status components found
- [ ] Handles components with no controls gracefully
- [ ] Performance acceptable with large designs (100+ components)

## Acceptance Criteria
- [ ] query_core_status returns real status data from Q-SYS design
- [ ] Status component detection works with common naming patterns
- [ ] Response format is clear and useful for monitoring
- [ ] Tool handles both StatusGet success and failure paths
- [ ] Performance impact is minimal (<1 second for typical designs)
- [ ] Breaking change is documented in changelog

## Related Issues
- Depends on: Existing QRWC connection and component discovery
- Enhances: Overall MCP tool usefulness for Q-SYS monitoring

## Notes
- This is a breaking change to the response format
- Consider caching status component list for performance
- Future enhancement: Add configurable detection patterns
- Future enhancement: Add threshold/alerting support

---
**Labels**: enhancement, high-priority, mcp-tools, breaking-change