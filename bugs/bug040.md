# BUG-040: Missing MCP Tool for Component.GetAllControls Command

**Severity**: Medium  
**Status**: Open  
**Component**: MCP Tools  
**Phase**: 2  
**Date**: 2024-01-20  

## Description
The `Component.GetAllControls` command is fully implemented in the QRWC adapter (src/mcp/qrwc/adapter.ts:367-398) but there is no corresponding MCP tool. This command retrieves all controls from all components in a single request, which is useful for system-wide monitoring and discovery.

## Current State
- **Implemented**: `Component.GetAllControls` case in adapter
- **Missing**: MCP tool to expose this functionality
- **Current workaround**: Multiple calls to list components then get controls for each

## Expected Behavior
AI agents should be able to get all controls system-wide:
```javascript
await callTool('qsys_get_all_controls', {
  includeValues: true
});
```

## API Specification
The adapter implements a custom aggregation that returns:
```json
{
  "result": [
    {
      "Name": "Component1.control1",
      "Value": -10.5,
      "String": "-10.5dB",
      "Type": "unknown",
      "Component": "Component1"
    },
    // ... more controls
  ]
}
```

## Proposed Implementation

### File: src/mcp/tools/discovery.ts (new file)
```typescript
import { z } from "zod";
import { BaseQSysTool, BaseToolParamsSchema } from "./base.js";
import type { ToolCallResult } from "../handlers/index.js";
import type { ToolExecutionContext } from "./base.js";

export const GetAllControlsParamsSchema = BaseToolParamsSchema.extend({
  includeValues: z.boolean().optional().default(true)
    .describe("Include current control values (default: true)"),
  componentFilter: z.string().optional()
    .describe("Optional regex pattern to filter components")
});

export type GetAllControlsParams = z.infer<typeof GetAllControlsParamsSchema>;

export class GetAllControlsTool extends BaseQSysTool<GetAllControlsParams> {
  constructor(qrwcClient: any) {
    super(
      qrwcClient,
      "qsys_get_all_controls",
      "Get all controls from all components in the Q-SYS system",
      GetAllControlsParamsSchema
    );
  }

  protected async executeInternal(
    params: GetAllControlsParams,
    context: ToolExecutionContext
  ): Promise<ToolCallResult> {
    try {
      const response = await this.qrwcClient.sendCommand("Component.GetAllControls");

      if (!response?.result || !Array.isArray(response.result)) {
        throw new Error("Invalid response from Component.GetAllControls");
      }

      let controls = response.result;

      // Apply component filter if provided
      if (params.componentFilter) {
        const regex = new RegExp(params.componentFilter);
        controls = controls.filter((ctrl: any) => 
          regex.test(ctrl.Component)
        );
      }

      const summary = `Found ${controls.length} controls across all components`;
      
      // Group by component for better readability
      const byComponent: Record<string, any[]> = {};
      controls.forEach((ctrl: any) => {
        if (!byComponent[ctrl.Component]) {
          byComponent[ctrl.Component] = [];
        }
        byComponent[ctrl.Component].push(ctrl);
      });

      let details = '';
      if (params.includeValues) {
        details = Object.entries(byComponent)
          .map(([comp, ctrls]) => 
            `\n${comp}:\n${ctrls.map((c: any) => 
              `  - ${c.Name}: ${c.Value} (${c.String})`
            ).join('\n')}`
          ).join('\n');
      }

      return {
        content: [
          {
            type: "text",
            text: summary + (details ? details : '')
          }
        ]
      };
    } catch (error) {
      throw this.createToolError(
        `Failed to get all controls: ${error}`,
        params
      );
    }
  }
}

export const createGetAllControlsTool = (qrwcClient: any) => 
  new GetAllControlsTool(qrwcClient);
```

### Update: src/mcp/handlers/index.ts
```typescript
import { createGetAllControlsTool } from "../tools/discovery.js";

// In registerQSysTools():
const qsysTools: Array<BaseQSysTool<any>> = [
  createListComponentsTool(this.qrwcClient),
  createGetComponentControlsTool(this.qrwcClient),
  createListControlsTool(this.qrwcClient),
  createGetControlValuesTool(this.qrwcClient),
  createSetControlValuesTool(this.qrwcClient),
  createQueryCoreStatusTool(this.qrwcClient),
  createLoadSnapshotTool(this.qrwcClient),
  createSaveSnapshotTool(this.qrwcClient),
  createGetAllControlsTool(this.qrwcClient), // ADD THIS
];
```

## Benefits
- Single request for system-wide control discovery
- Useful for monitoring and diagnostics
- Efficient for building control maps
- Supports filtering to reduce data volume

## Test Requirements
1. Test retrieving all controls
2. Test component filtering
3. Test with large systems (performance)
4. Test output formatting
5. Verify all control metadata is included

## Performance Considerations
- This command can return large datasets
- Consider pagination or limiting in future versions
- Component filtering helps reduce response size