# BUG-040: Adapter.ts File Exceeds Maintainable Size Limits

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: QRWC Adapter  
**Reported Date**: 2025-01-20  
**Reporter**: Phase-2 Audit  
**Assignee**: Unassigned  

## Summary
The adapter.ts file has grown to over 500 lines, making it difficult to maintain and violating single responsibility principle.

## Description
The QRWC adapter file contains:
- Connection management logic
- Message handling for multiple message types
- Event handling and dispatching
- Error handling and retry logic
- Component state management
- Control change processing

This monolithic structure:
- Makes the code hard to navigate
- Increases cognitive load for developers
- Makes testing individual features difficult
- Violates separation of concerns

## Steps to Reproduce
1. Open `src/mcp/qrwc/adapter.ts`
2. Count lines and analyze responsibilities
3. Expected result: Focused class with single responsibility
4. Actual result: 500+ line file handling multiple concerns

## Expected Behavior
The adapter should be split into focused modules:
- ConnectionManager: WebSocket connection handling
- MessageHandler: Message parsing and routing
- ComponentManager: Component state operations
- ControlManager: Control change operations
- EventDispatcher: Event handling logic

## Actual Behavior
Single large file attempting to handle all Q-SYS integration concerns.

## Environment
- **OS**: All
- **Node.js Version**: v20.x
- **Project Version/Commit**: bug/001-fix branch

## Root Cause Analysis
- **File(s)**: `src/mcp/qrwc/adapter.ts`
- **Line(s)**: Entire file (500+ lines)
- **Cause**: Organic growth without refactoring

## Proposed Solution
```typescript
// Split into focused modules:

// connection-manager.ts
export class ConnectionManager {
  constructor(private config: ConnectionConfig) {}
  async connect(): Promise<WebSocket> { }
  async disconnect(): Promise<void> { }
  isConnected(): boolean { }
}

// message-handler.ts
export class MessageHandler {
  handleMessage(message: QSYSMessage): void {
    switch(message.type) {
      case 'component': this.componentHandler.handle(message); break;
      case 'control': this.controlHandler.handle(message); break;
      // etc.
    }
  }
}

// component-manager.ts
export class ComponentManager {
  async getComponents(): Promise<Component[]> { }
  async getComponent(id: string): Promise<Component> { }
}

// New adapter.ts - orchestrates the modules
export class QRWCAdapter {
  constructor(
    private connection: ConnectionManager,
    private messages: MessageHandler,
    private components: ComponentManager
  ) {}
}
```

## Test Cases
- [ ] Test each module in isolation
- [ ] Test module integration
- [ ] Ensure no functionality lost
- [ ] Verify improved testability

## Related Issues
- Related to: Code organization and maintainability

## Acceptance Criteria
- [ ] Adapter split into focused modules
- [ ] Each module under 200 lines
- [ ] Clear interfaces between modules
- [ ] All existing tests passing

---
**Labels**: bug, qrwc-adapter, medium-priority, refactoring