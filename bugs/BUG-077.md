# BUG-077: Event Cache query engine missing pagination support

**Status**: Open  
**Severity**: Medium  
**Priority**: P2 (Medium)  
**Component**: State Management / Event Cache  
**Reported Date**: 2025-07-23  
**Reporter**: System Analysis  
**Assignee**: Unassigned  

## Summary
The Event Cache query engine lacks offset/pagination support, making it impossible to retrieve large result sets in chunks or implement proper pagination in UIs.

## Description
The EventQuery interface includes a `limit` parameter but no `offset` parameter. This prevents:
- Paginating through large result sets
- Implementing "Load More" functionality
- Efficiently retrieving results beyond the limit
- Memory-efficient processing of large queries
- Building paginated UIs for event history

Without pagination, users must either retrieve all results (memory intensive) or only see the first N results with no way to access the rest.

## Steps to Reproduce
1. Create an EventCacheManager with 10,000 events
2. Query with limit: 100
3. Receive first 100 events
4. Try to get events 101-200
5. Observe there's no offset parameter to skip the first 100
6. Only option is to increase limit to 200 and discard first 100

## Expected Behavior
- EventQuery should include an `offset` parameter
- Query with offset: 100, limit: 100 returns events 101-200
- Offset should work with all other query parameters
- Results should maintain consistent ordering across pages

## Actual Behavior
- No offset parameter available
- Cannot skip events to implement pagination
- Must retrieve all previous events to reach desired offset
- No efficient way to implement pagination

## Environment
- **OS**: All
- **Node.js Version**: v20.11.0+
- **Project Version/Commit**: Current main branch

## Error Logs/Stack Trace
N/A - Missing functionality

## Root Cause Analysis
- **File(s)**: src/mcp/state/event-cache/manager.ts
- **Line(s)**: 33-44 (EventQuery interface), 286-288 (limit implementation)
- **Cause**: Offset parameter was not included in initial implementation

## Proposed Solution
```typescript
// Update EventQuery interface
export interface EventQuery {
  groupId?: string | undefined;
  startTime?: number | undefined;
  endTime?: number | undefined;
  controlNames?: string[] | undefined;
  valueFilter?: {
    operator: 'eq' | 'neq' | 'gt' | 'lt' | 'changed_to' | 'changed_from';
    value?: unknown;
  } | undefined;
  limit?: number | undefined;
  offset?: number | undefined; // NEW
  aggregation?: 'raw' | 'changes_only' | 'summary' | undefined;
}

// Update query method
query(params: EventQuery): CachedEvent[] {
  const {
    groupId,
    startTime = Date.now() - 60000,
    endTime = Date.now(),
    controlNames,
    valueFilter,
    limit = 1000,
    offset = 0, // NEW: default to 0
    aggregation = 'raw'
  } = params;
  
  // ... existing query logic ...
  
  // Apply offset and limit together
  if (offset > 0 || limit > 0) {
    const start = offset;
    const end = limit > 0 ? start + limit : results.length;
    results = results.slice(start, end);
  }
  
  logger.debug('Query completed', {
    resultCount: results.length,
    offset,
    limit,
    totalBeforePagination: results.length + offset,
    firstEvent: results[0]?.timestampMs,
    lastEvent: results[results.length - 1]?.timestampMs
  });
  
  return results;
}

// Add to query result metadata (future enhancement)
export interface QueryResult {
  events: CachedEvent[];
  pagination: {
    offset: number;
    limit: number;
    totalCount: number; // Total matching events before pagination
    hasMore: boolean;
  };
}

// Update MCP tool schema
const ReadChangeGroupEventsParamsSchema = z.object({
  // ... existing fields ...
  limit: z.number().min(1).max(10000).optional(),
  offset: z.number().min(0).optional(), // NEW
});
```

## Workaround
- Increase limit and manually slice results in application code
- Use time-based pagination (query next time window)
- Neither workaround is efficient for large result sets

## Test Cases
- [ ] Unit test: Query with offset skips correct number of events
- [ ] Unit test: Offset + limit returns correct page
- [ ] Unit test: Offset beyond result count returns empty array
- [ ] Unit test: Offset works with all filter combinations
- [ ] Integration test: Consistent pagination across multiple queries
- [ ] Edge case: Offset of 0 behaves same as no offset

## Related Issues
- Related to: BUG-072 (Event Cache implementation)
- Related to: Phase 1.3 Query Engine requirements

## Additional Context
- Standard feature for any query API
- Essential for building UIs with event history
- Low implementation complexity
- Consider returning total count for pagination UI

## Acceptance Criteria
- [ ] Offset parameter available in EventQuery
- [ ] Offset correctly skips specified number of results
- [ ] Offset + limit implements proper pagination
- [ ] MCP tool schema includes offset parameter
- [ ] Documentation includes pagination examples
- [ ] All tests pass

## Notes
While this is marked as Medium priority, it's a significant usability issue for any UI that needs to display event history. The implementation is straightforward and should be included before GA.

---
**Labels**: bug, event-cache, query-engine, pagination, medium-priority  
**Milestone**: Event Cache GA